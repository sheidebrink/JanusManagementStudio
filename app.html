<!DOCTYPE html>
<html>
<head>
  <title>Janus Management Studio</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    .header {
      background: #667eea;
      color: white;
      padding: 15px;
      margin: -20px -20px 20px -20px;
    }
    .query-section {
      background: white;
      padding: 20px;
      border-radius: 5px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    textarea {
      width: 100%;
      height: 150px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-family: 'Courier New', monospace;
      resize: vertical;
    }
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover {
      background: #5a6fd8;
    }
    .results {
      background: white;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 12px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px;
      text-align: left;
      white-space: nowrap;
    }
    th {
      background: #f8f9fa;
    }
    .error {
      color: #e74c3c;
      background: #fdf2f2;
      padding: 10px;
      border-radius: 5px;
      border-left: 4px solid #e74c3c;
    }
    .menubar {
      background: #f0f0f0;
      border-bottom: 1px solid #ccc;
      padding: 0;
      margin: -20px -20px 0 -20px;
      display: flex;
    }
    .menu-item {
      padding: 8px 16px;
      cursor: pointer;
      position: relative;
      user-select: none;
    }
    .menu-item:hover {
      background: #e0e0e0;
    }
    .dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      border: 1px solid #ccc;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      min-width: 120px;
      z-index: 1000;
    }
    .dropdown div {
      padding: 8px 16px;
      cursor: pointer;
    }
    .dropdown div:hover {
      background: #f0f0f0;
    }
    .page {
      display: none;
    }
    .page.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="menubar">
    <div class="menu-item" onclick="showHomePage()">üè† Home</div>
    <div class="menu-item" onclick="toggleMenu('systemMenu')">
      System
      <div id="systemMenu" class="dropdown">
        <div onclick="showTenantsPage()">Tenants</div>
      </div>
    </div>
    <div class="menu-item" onclick="toggleMenu('manageMenu')">
      Manage
      <div id="manageMenu" class="dropdown">
        <div onclick="showWorkflowsPage()">Workflows</div>
      </div>
    </div>
  </div>
  
  <div class="header">
    <h1>Janus Management Studio</h1>
    <p>Connected to database</p>
  </div>
  
  <div id="homePage" class="page active">
    <div class="query-section">
      <h3>Welcome to Janus Management Studio</h3>
      <div id="connectionInfo">
        <p><strong>Database:</strong> <span id="currentDatabase">Loading...</span></p>
        <p><strong>Current Tenant:</strong> <span id="currentTenant">None selected</span></p>
      </div>
      <hr>
      <p>Use the menu above to navigate to different sections:</p>
      <ul>
        <li><strong>System ‚Üí Tenants</strong> - View and manage tenant information</li>
        <li><strong>Manage ‚Üí Workflows</strong> - View workflows for selected tenant</li>
      </ul>
    </div>
  </div>

  <div id="tenantsPage" class="page">
    <div class="query-section">
      <h3>System - Tenants</h3>
      <button onclick="loadTenants()">Refresh Tenants</button>
      <button onclick="loadAllTenants()">Show All (Including Deleted)</button>
    </div>
    
    <div class="results">
      <h3>Tenants List</h3>
      <div id="tenantsResults">Loading tenants...</div>
    </div>
  </div>

  <div id="workflowsPage" class="page">
    <div class="query-section">
      <h3>Manage - Workflows</h3>
      <p id="workflowTenantInfo">No tenant selected. Please select a tenant first.</p>
      <button onclick="loadWorkflows()" id="refreshWorkflowsBtn" disabled>Refresh Workflows</button>
    </div>
    
    <div class="results">
      <h3>Workflows List</h3>
      <div id="workflowsResults">Select a tenant to view workflows.</div>
    </div>
  </div>

  <div id="workflowOpenPage" class="page">
    <div class="query-section">
      <h3 id="workflowTitle">Workflow Details</h3>
      <button onclick="showWorkflowsPage()">‚Üê Back to Workflows</button>
    </div>
    
    <div class="results">
      <h4>Workflow Information</h4>
      <div id="workflowDetails">Loading workflow details...</div>
      
      <h4>Workflow Activities</h4>
      <div id="workflowActivities">Loading activities...</div>
    </div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');
    
    // Load context on page load
    window.addEventListener('DOMContentLoaded', async () => {
      await updateContext();
    });
    
    async function updateContext() {
      try {
        const context = await ipcRenderer.invoke('get-context');
        document.getElementById('currentDatabase').textContent = context.database || 'Not connected';
        document.getElementById('currentTenant').textContent = context.tenant ? 
          `${context.tenant.name} (ID: ${context.tenant.id})` : 'None selected';
      } catch (error) {
        console.error('Failed to load context:', error);
      }
    }
    
    function toggleMenu(menuId) {
      const menu = document.getElementById(menuId);
      const isVisible = menu.style.display === 'block';
      
      // Hide all dropdowns
      document.querySelectorAll('.dropdown').forEach(d => d.style.display = 'none');
      
      // Show clicked menu if it wasn't visible
      if (!isVisible) {
        menu.style.display = 'block';
      }
    }
    
    // Close dropdowns when clicking elsewhere
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.menu-item')) {
        document.querySelectorAll('.dropdown').forEach(d => d.style.display = 'none');
      }
    });
    
    function createTable(data) {
      if (!data || data.length === 0) return '';
      
      const headers = Object.keys(data[0]);
      let html = '<table><thead><tr>';
      
      headers.forEach(header => {
        html += `<th>${header}</th>`;
      });
      html += '</tr></thead><tbody>';
      
      data.forEach(row => {
        html += '<tr>';
        headers.forEach(header => {
          const value = row[header] !== null ? row[header] : 'NULL';
          html += `<td>${value}</td>`;
        });
        html += '</tr>';
      });
      
      html += '</tbody></table>';
      return html;
    }
    
    function createTenantsTable(data) {
      if (!data || data.length === 0) return '';
      
      const headers = Object.keys(data[0]);
      let html = '<table><thead><tr><th>Action</th>';
      
      headers.forEach(header => {
        html += `<th>${header}</th>`;
      });
      html += '</tr></thead><tbody>';
      
      data.forEach(row => {
        html += '<tr>';
        html += `<td><button onclick="setTenant(${row.Id}, '${row.Name}')">Set as Current</button></td>`;
        headers.forEach(header => {
          const value = row[header] !== null ? row[header] : 'NULL';
          html += `<td>${value}</td>`;
        });
        html += '</tr>';
      });
      
      html += '</tbody></table>';
      return html;
    }
    
    async function setTenant(tenantId, tenantName) {
      try {
        await ipcRenderer.invoke('set-tenant', tenantId, tenantName);
        alert(`Current tenant set to: ${tenantName} (ID: ${tenantId})`);
        showHomePage();
      } catch (error) {
        alert(`Failed to set tenant: ${error.message}`);
      }
    }
    
    function showHomePage() {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('homePage').classList.add('active');
      document.querySelectorAll('.dropdown').forEach(d => d.style.display = 'none');
      updateContext();
    }
    
    function showTenantsPage() {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('tenantsPage').classList.add('active');
      document.querySelectorAll('.dropdown').forEach(d => d.style.display = 'none');
      loadTenants();
    }
    
    async function loadTenants() {
      const resultsDiv = document.getElementById('tenantsResults');
      resultsDiv.innerHTML = 'Loading tenants...';
      
      try {
        const result = await ipcRenderer.invoke('execute-query', 
          `SELECT Id, Name, DefaultColor, DefaultPrimaryColor, 
                  CASE WHEN UseLightTheme = 1 THEN 'Yes' ELSE 'No' END as UseLightTheme,
                  CreatedById, CreatedDate, UpdatedById, UpdatedDate,
                  CASE WHEN IsDeleted = 1 THEN 'Yes' ELSE 'No' END as IsDeleted
           FROM Tenants 
           WHERE IsDeleted = 0
           ORDER BY Id`);
        
        if (result.success) {
          if (result.data && result.data.length > 0) {
            const table = createTenantsTable(result.data);
            resultsDiv.innerHTML = `<p>${result.data.length} active tenants found.</p>${table}`;
          } else {
            resultsDiv.innerHTML = '<p>No active tenants found.</p>';
          }
        } else {
          resultsDiv.innerHTML = `<div class="error">Failed to load tenants: ${result.error}</div>`;
        }
      } catch (error) {
        resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
      }
    }
    
    async function loadAllTenants() {
      const resultsDiv = document.getElementById('tenantsResults');
      resultsDiv.innerHTML = 'Loading all tenants...';
      
      try {
        const result = await ipcRenderer.invoke('execute-query', 
          `SELECT Id, Name, DefaultColor, DefaultPrimaryColor, 
                  CASE WHEN UseLightTheme = 1 THEN 'Yes' ELSE 'No' END as UseLightTheme,
                  CreatedById, CreatedDate, UpdatedById, UpdatedDate,
                  CASE WHEN IsDeleted = 1 THEN 'Yes' ELSE 'No' END as IsDeleted,
                  DeletedDate
           FROM Tenants 
           ORDER BY IsDeleted, Id`);
        
        if (result.success) {
          if (result.data && result.data.length > 0) {
            const table = createTable(result.data);
            resultsDiv.innerHTML = `<p>${result.data.length} total tenants found.</p>${table}`;
          } else {
            resultsDiv.innerHTML = '<p>No tenants found.</p>';
          }
        } else {
          resultsDiv.innerHTML = `<div class="error">Failed to load tenants: ${result.error}</div>`;
        }
      } catch (error) {
        resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
      }
    }
    
    function showWorkflowsPage() {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('workflowsPage').classList.add('active');
      document.querySelectorAll('.dropdown').forEach(d => d.style.display = 'none');
      updateWorkflowsContext();
    }
    
    async function updateWorkflowsContext() {
      try {
        const context = await ipcRenderer.invoke('get-context');
        const tenantInfo = document.getElementById('workflowTenantInfo');
        const refreshBtn = document.getElementById('refreshWorkflowsBtn');
        
        if (context.tenant) {
          tenantInfo.textContent = `Showing workflows for: ${context.tenant.name} (ID: ${context.tenant.id})`;
          refreshBtn.disabled = false;
          loadWorkflows();
        } else {
          tenantInfo.textContent = 'No tenant selected. Please select a tenant first.';
          refreshBtn.disabled = true;
          document.getElementById('workflowsResults').innerHTML = 'Select a tenant to view workflows.';
        }
      } catch (error) {
        console.error('Failed to load context:', error);
      }
    }
    
    async function loadWorkflows() {
      const resultsDiv = document.getElementById('workflowsResults');
      
      try {
        const context = await ipcRenderer.invoke('get-context');
        if (!context.tenant) {
          resultsDiv.innerHTML = '<div class="error">No tenant selected</div>';
          return;
        }
        
        resultsDiv.innerHTML = 'Loading workflows...';
        
        const result = await ipcRenderer.invoke('execute-query', 
          `SELECT Id, Name, 
                  CASE WHEN SyncEnabled = 1 THEN 'Yes' ELSE 'No' END as SyncEnabled,
                  CASE WHEN IsRouter = 1 THEN 'Yes' ELSE 'No' END as IsRouter,
                  CASE WHEN IsRoutable = 1 THEN 'Yes' ELSE 'No' END as IsRoutable,
                  CASE WHEN IsReRouteAllowed = 1 THEN 'Yes' ELSE 'No' END as IsReRouteAllowed,
                  EmailUserName, EmailMailboxOwner,
                  CreatedById, CreatedDate, UpdatedById, UpdatedDate
           FROM Workflows 
           WHERE TenantId = ${context.tenant.id} AND IsDeleted = 0
           ORDER BY Name`);
        
        if (result.success) {
          if (result.data && result.data.length > 0) {
            const table = createWorkflowsTable(result.data);
            resultsDiv.innerHTML = `<p>${result.data.length} workflows found for tenant ${context.tenant.name}.</p>${table}`;
          } else {
            resultsDiv.innerHTML = `<p>No workflows found for tenant ${context.tenant.name}.</p>`;
          }
        } else {
          resultsDiv.innerHTML = `<div class="error">Failed to load workflows: ${result.error}</div>`;
        }
      } catch (error) {
        resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
      }
    }
    
    function createWorkflowsTable(data) {
      if (!data || data.length === 0) return '';
      
      const headers = Object.keys(data[0]);
      let html = '<table><thead><tr><th>Action</th>';
      
      headers.forEach(header => {
        html += `<th>${header}</th>`;
      });
      html += '</tr></thead><tbody>';
      
      data.forEach(row => {
        html += '<tr>';
        html += `<td><button onclick="openWorkflow(${row.Id}, '${row.Name}')">Open</button></td>`;
        headers.forEach(header => {
          const value = row[header] !== null ? row[header] : 'NULL';
          html += `<td>${value}</td>`;
        });
        html += '</tr>';
      });
      
      html += '</tbody></table>';
      return html;
    }
    
    async function openWorkflow(workflowId, workflowName) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('workflowOpenPage').classList.add('active');
      document.getElementById('workflowTitle').textContent = `Workflow: ${workflowName}`;
      
      await loadWorkflowDetails(workflowId);
      await loadWorkflowActivities(workflowId);
    }
    
    async function loadWorkflowDetails(workflowId) {
      const detailsDiv = document.getElementById('workflowDetails');
      detailsDiv.innerHTML = 'Loading workflow details...';
      
      try {
        const result = await ipcRenderer.invoke('execute-query', 
          `SELECT Id, TenantId, Name, EmailSignature, EmailUserName, EmailMailboxOwner,
                  CASE WHEN SyncEnabled = 1 THEN 'Yes' ELSE 'No' END as SyncEnabled,
                  CASE WHEN IsRouter = 1 THEN 'Yes' ELSE 'No' END as IsRouter,
                  CASE WHEN IsRoutable = 1 THEN 'Yes' ELSE 'No' END as IsRoutable,
                  CASE WHEN IsReRouteAllowed = 1 THEN 'Yes' ELSE 'No' END as IsReRouteAllowed,
                  CreatedById, CreatedDate, UpdatedById, UpdatedDate
           FROM Workflows 
           WHERE Id = ${workflowId}`);
        
        if (result.success && result.data && result.data.length > 0) {
          const table = createTable(result.data);
          detailsDiv.innerHTML = table;
        } else {
          detailsDiv.innerHTML = '<div class="error">Workflow not found</div>';
        }
      } catch (error) {
        detailsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
      }
    }
    
    async function loadWorkflowActivities(workflowId) {
      const activitiesDiv = document.getElementById('workflowActivities');
      activitiesDiv.innerHTML = 'Loading activities...';
      
      try {
        const result = await ipcRenderer.invoke('execute-query', 
          `SELECT wa.Id, wa.Name, sv.Name as ActivityType, wa.Position,
                  wa.ServiceLevelAgreementTicks,
                  CASE WHEN wa.RequireSubcategoryWhenCategorySelected = 1 THEN 'Yes' ELSE 'No' END as RequireSubcategory,
                  CASE WHEN wa.IsReopenReplyRequired = 1 THEN 'Yes' ELSE 'No' END as ReopenReplyRequired,
                  wa.CreatedById, wa.CreatedDate, wa.UpdatedById, wa.UpdatedDate
           FROM WorkflowActivities wa
           LEFT JOIN SystemValues sv ON wa.ActivityTypeValueId = sv.Id
           WHERE wa.WorkflowId = ${workflowId} AND wa.IsDeleted = 0
           ORDER BY wa.Position`);
        
        if (result.success) {
          if (result.data && result.data.length > 0) {
            const table = createTable(result.data);
            activitiesDiv.innerHTML = `<p>${result.data.length} activities found.</p>${table}`;
          } else {
            activitiesDiv.innerHTML = '<p>No activities found for this workflow.</p>';
          }
        } else {
          activitiesDiv.innerHTML = `<div class="error">Failed to load activities: ${result.error}</div>`;
        }
      } catch (error) {
        activitiesDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
      }
    }
  </script>
</body>
</html>