<!DOCTYPE html>
<html>
<head>
  <title>Janus Management Studio</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    .header {
      background: #667eea;
      color: white;
      padding: 15px;
      margin: -20px -20px 20px -20px;
    }
    .query-section {
      background: white;
      padding: 20px;
      border-radius: 5px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    textarea {
      width: 100%;
      height: 150px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-family: 'Courier New', monospace;
      resize: vertical;
    }
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover {
      background: #5a6fd8;
    }
    .results {
      background: white;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 12px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px;
      text-align: left;
      white-space: nowrap;
    }
    .logs-table {
      font-size: 10px;
    }
    .logs-table th, .logs-table td {
      padding: 4px;
      max-width: 150px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .logs-table .description-col {
      max-width: 200px;
    }
    .logs-table .summary-col {
      max-width: 120px;
    }
    .tracking-table .data-col {
      max-width: 200px;
      white-space: normal;
      word-wrap: break-word;
    }
    .tracking-table .path-col {
      max-width: 200px;
      white-space: normal;
      word-wrap: break-word;
    }
    th {
      background: #f8f9fa;
    }
    .error {
      color: #e74c3c;
      background: #fdf2f2;
      padding: 10px;
      border-radius: 5px;
      border-left: 4px solid #e74c3c;
    }
    .menubar {
      background: #f0f0f0;
      border-bottom: 1px solid #ccc;
      padding: 0;
      margin: -20px -20px 0 -20px;
      display: flex;
    }
    .menu-item {
      padding: 8px 16px;
      cursor: pointer;
      position: relative;
      user-select: none;
    }
    .menu-item:hover {
      background: #e0e0e0;
    }
    .dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      border: 1px solid #ccc;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      min-width: 120px;
      z-index: 2000;
    }
    .dropdown div {
      padding: 8px 16px;
      cursor: pointer;
    }
    .dropdown div:hover {
      background: #f0f0f0;
    }
    .page {
      display: none;
    }
    .page.active {
      display: block;
    }
    input[type="text"] {
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: 3px;
    }
    .chart-tooltip {
      position: absolute;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 8px;
      border-radius: 4px;
      font-size: 12px;
      pointer-events: none;
      z-index: 1000;
      display: none;
    }
    .workflow-tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-bottom: 20px;
    }
    .tab-button {
      background: #f8f9fa;
      border: 1px solid #ddd;
      border-bottom: none;
      padding: 10px 20px;
      cursor: pointer;
      margin-right: 2px;
      color: #333;
      font-weight: bold;
    }
    .tab-button.active {
      background: white;
      border-bottom: 1px solid white;
      margin-bottom: -1px;
      color: #667eea;
    }
    .tab-button:hover {
      background: #e9ecef;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .workflow-details-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      background: white;
      padding: 20px;
      border-radius: 5px;
    }
    .detail-item {
      display: flex;
      flex-direction: column;
      margin-bottom: 15px;
    }
    .detail-label {
      font-weight: bold;
      color: #555;
      margin-bottom: 5px;
    }
    .detail-value {
      color: #333;
      padding: 8px;
      background: #f8f9fa;
      border-radius: 3px;
      border: 1px solid #e9ecef;
    }
    .chart-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 10;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 3000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: white;
      margin: 5% auto;
      padding: 20px;
      border-radius: 5px;
      width: 80%;
      max-height: 80%;
      overflow-y: auto;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: black;
    }
    .body-icon {
      cursor: pointer;
      color: #667eea;
      margin-left: 10px;
      font-size: 16px;
    }
    .body-icon:hover {
      color: #5a6fd8;
    }
  </style>
</head>
<body>
  <div class="menubar">
    <div class="menu-item" onclick="showHomePage()">üè† Home</div>
    <div class="menu-item" onclick="toggleMenu('systemMenu')">
      ‚öôÔ∏è System
      <div id="systemMenu" class="dropdown">
        <div onclick="showTenantsPage(); closeAllMenus()">üë• Tenants</div>
        <div onclick="showUserTrackingPage(); closeAllMenus()">üìä User Tracking</div>
        <div onclick="showLogsPage(); closeAllMenus()">üìÑ Logs</div>
        <div onclick="showRolesPage(); closeAllMenus()">üîë Roles</div>
        <div onclick="showModulesPage(); closeAllMenus()">üì¶ Modules</div>
        <div onclick="showDataDictionaryPage(); closeAllMenus()">üìö Data Dictionary</div>
      </div>
    </div>
    <div class="menu-item" onclick="toggleMenu('manageMenu')">
      üìã Manage
      <div id="manageMenu" class="dropdown">
        <div onclick="showWorkflowsPage(); closeAllMenus()">üîÑ Workflows</div>
      </div>
    </div>
    <div class="menu-item" onclick="toggleMenu('devMenu')">
      üîß Developer
      <div id="devMenu" class="dropdown">
        <div onclick="toggleDevTools(); closeAllMenus()">üîç Console (F12)</div>
      </div>
    </div>
  </div>
  
  <div class="header">
    <h1>Janus Management Studio</h1>
    <p id="headerConnectionInfo">Connected to database</p>
  </div>
  
  <div id="homePage" class="page active">
    <div class="query-section">
      <h3>Welcome to Janus Management Studio</h3>
      <div id="connectionInfo">
        <p><strong>Database:</strong> <span id="currentDatabase">Loading...</span></p>
        <p><strong>Current Tenant:</strong> <span id="currentTenant">None selected</span></p>
      </div>
      <hr>
      <p>Use the menu above to navigate to different sections:</p>
      <ul>
        <li><strong>System ‚Üí Tenants</strong> - View and manage tenant information</li>
        <li><strong>System ‚Üí User Tracking</strong> - View user activity tracking data</li>
        <li><strong>System ‚Üí Logs</strong> - View system logs and errors</li>
        <li><strong>System ‚Üí Roles</strong> - View roles, workflows, and user assignments</li>
        <li><strong>System ‚Üí Modules</strong> - View system modules</li>
        <li><strong>Manage ‚Üí Workflows</strong> - View workflows for selected tenant</li>
      </ul>
    </div>
  </div>

  <div id="tenantsPage" class="page">
    <div class="query-section">
      <h3>System - Tenants</h3>
      <button onclick="loadTenants()">Refresh Tenants</button>
      <button onclick="loadAllTenants()">Show All (Including Deleted)</button>
    </div>
    
    <div class="results">
      <h3>Tenants List</h3>
      <div id="tenantsResults">Loading tenants...</div>
    </div>
  </div>

  <div id="workflowsPage" class="page">
    <div class="query-section">
      <h3>Manage - Workflows</h3>
      <p id="workflowTenantInfo">No tenant selected. Please select a tenant first.</p>
      <button onclick="loadWorkflows()" id="refreshWorkflowsBtn" disabled>Refresh Workflows</button>
    </div>
    
    <div class="results">
      <h3>Workflows List</h3>
      <div id="workflowsResults">Select a tenant to view workflows.</div>
    </div>
  </div>

  <div id="userTrackingPage" class="page">
    <div class="query-section">
      <h3>System - User Tracking</h3>
      <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
        <div style="flex: 1;">
          <label style="font-weight: bold; display: block;">From Date</label>
          <input type="date" id="dateFromFilter" style="width: 100%;">
        </div>
        <div style="flex: 1;">
          <label style="font-weight: bold; display: block;">Through Date</label>
          <input type="date" id="dateThroughFilter" style="width: 100%;">
        </div>
        <div style="flex: 1;">
          <label style="font-weight: bold; display: block;">Module</label>
          <select id="moduleFilter" multiple style="width: 100%; height: 80px;" onchange="filterFunctionsByModule()">
            <option value="">Loading modules...</option>
          </select>
        </div>
        <div style="flex: 1;">
          <label style="font-weight: bold; display: block;">Function</label>
          <select id="functionFilter" multiple style="width: 100%; height: 80px;">
            <option value="">Loading functions...</option>
          </select>
        </div>
        <div style="flex: 1;">
          <label style="font-weight: bold; display: block;">Tenant</label>
          <select id="tenantFilter" multiple style="width: 100%; height: 80px;">
            <option value="">Loading tenants...</option>
          </select>
        </div>
        <div style="align-self: flex-end;">
          <button onclick="loadUserTracking(1)">Apply Filters</button>
          <button onclick="clearFilters()">Clear</button>
        </div>
      </div>
      <div id="trackingPagination" style="margin-bottom: 10px;"></div>
    </div>
    
    <div class="results">
      <h3>User Tracking Data</h3>
      <div id="userTrackingResults">Loading user tracking data...</div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%;">
        <div style="width: 100%; position: relative;">
          <h3>Top 10 Functions</h3>
          <canvas id="functionsChart" width="500" height="300"></canvas>
        </div>
        <div style="width: 100%; position: relative;">
          <h3>Top 10 URL Paths</h3>
          <canvas id="pathsChart" width="500" height="300"></canvas>
        </div>
        <div style="width: 100%; position: relative;">
          <h3>Top 10 Modules</h3>
          <canvas id="modulesChart" width="500" height="300"></canvas>
        </div>
        <div style="width: 100%; position: relative;">
          <h3>Top 10 Users</h3>
          <canvas id="usersChart" width="500" height="300"></canvas>
        </div>
      </div>
      <div id="chartTooltip" class="chart-tooltip"></div>
    </div>
  </div>

  <div id="logsPage" class="page">
    <div class="query-section">
      <h3>System - Logs</h3>
      <div style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin-bottom: 15px; border-left: 4px solid #2196f3;">
        <h4 style="margin: 0 0 10px 0; color: #1976d2;">üìö Log Levels Guide for Developers</h4>
        <div style="font-size: 12px; line-height: 1.4;">
          <strong>Trace:</strong> Very detailed info for diagnosing issues ‚Ä¢ <strong>Debug:</strong> Info useful during development ‚Ä¢ <strong>Information:</strong> General app flow tracking ‚Ä¢ <strong>Warning:</strong> Unexpected but recoverable events ‚Ä¢ <strong>Error:</strong> Exceptions and failures ‚Ä¢ <strong>Critical:</strong> Serious failures requiring immediate attention
        </div>
      </div>
      <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 15px; border: 1px solid #dee2e6;">
        <h4 style="margin: 0 0 10px 0;">Solution Path Configuration</h4>
        <div style="display: flex; gap: 10px; align-items: flex-end;">
          <div style="flex: 1;">
            <label style="font-weight: bold; display: block;">Solution Path</label>
            <input type="text" id="solutionPath" placeholder="C:\path\to\your\solution" style="width: 100%; padding: 5px;">
          </div>
          <button onclick="browseSolutionPath()">Browse</button>
          <button onclick="saveSolutionPath()">Save</button>
        </div>
      </div>
      <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
        <div style="flex: 1;">
          <label style="font-weight: bold; display: block;">From Date</label>
          <input type="date" id="logsDateFromFilter" style="width: 100%;">
        </div>
        <div style="flex: 1;">
          <label style="font-weight: bold; display: block;">Through Date</label>
          <input type="date" id="logsDateThroughFilter" style="width: 100%;">
        </div>
        <div style="flex: 1;">
          <label style="font-weight: bold; display: block;">Log Level</label>
          <select id="logLevelFilter" multiple style="width: 100%; height: 80px;">
            <option value="">Loading log levels...</option>
          </select>
        </div>
        <div style="align-self: flex-end;">
          <button onclick="loadLogs(1)">Apply Filters</button>
          <button onclick="clearLogsFilters()">Clear</button>
        </div>
      </div>
      <div id="logsPagination" style="margin-bottom: 10px;"></div>
    </div>
    
    <div class="results">
      <h3>System Logs</h3>
      <div id="logsResults">Loading logs...</div>
      
      <div style="margin-top: 30px; width: 100%; position: relative;">
        <h4>Log Levels Distribution</h4>
        <canvas id="logLevelsChart" width="800" height="400"></canvas>
      </div>
      <div id="logChartTooltip" class="chart-tooltip"></div>
    </div>
  </div>

  <div id="modulesPage" class="page">
    <div class="query-section">
      <h3>System - Modules</h3>
      <button onclick="loadModules()">Refresh Modules</button>
    </div>
    
    <div class="results">
      <h3>System Modules</h3>
      <div id="modulesResults">Loading modules...</div>
    </div>
  </div>

  <div id="dataDictionaryPage" class="page">
    <div class="query-section">
      <h3>System - Data Dictionary</h3>
      <button onclick="loadDataDictionary()">Generate Data Dictionary</button>
      <button onclick="loadERD()">Show ERD</button>
      <button onclick="exportDataDictionary()">Export to HTML</button>
    </div>
    
    <div class="results">
      <div class="workflow-tabs">
        <button class="tab-button active" onclick="showDictionaryTab('dictionary')">Data Dictionary</button>
        <button class="tab-button" onclick="showDictionaryTab('erd')">ERD</button>
      </div>
      
      <div id="dictionaryTab" class="tab-content active">
        <h3>Database Schema Documentation</h3>
        <div style="margin-bottom: 15px;">
          <label style="font-weight: bold;">Schema Filter:</label>
          <select id="dictionarySchemaFilter" onchange="loadDataDictionary()" style="margin-left: 10px; padding: 5px;">
            <option value="">All Schemas</option>
          </select>
        </div>
        <div id="dataDictionaryResults">Click "Generate Data Dictionary" to load database schema information.</div>
      </div>
      
      <div id="erdTab" class="tab-content">
        <h3>Entity Relationship Diagram</h3>
        <div style="margin-bottom: 15px;">
          <label style="font-weight: bold;">Schema Filter:</label>
          <select id="schemaFilter" onchange="loadERD()" style="margin-left: 10px; padding: 5px;">
            <option value="">All Schemas</option>
          </select>
        </div>
        <div style="margin-bottom: 10px; font-size: 12px; color: #666;">Drag tables to reposition. Lines show foreign key relationships.</div>
        <canvas id="erdCanvas" width="1200" height="800" style="border: 1px solid #ddd; background: white; cursor: move;"></canvas>
      </div>
    </div>
  </div>

  <div id="rolesPage" class="page">
    <div class="query-section">
      <h3>System - Roles</h3>
      <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
        <div>
          <label style="font-weight: bold; display: block;">Tenant</label>
          <select id="rolesTenantFilter" multiple style="width: 120px; height: 80px;">
            <option value="">Loading tenants...</option>
          </select>
        </div>
        <div>
          <label style="font-weight: bold; display: block;">Role</label>
          <select id="rolesRoleFilter" multiple style="width: 120px; height: 80px;">
            <option value="">Loading roles...</option>
          </select>
        </div>
        <div>
          <label style="font-weight: bold; display: block;">Module</label>
          <select id="rolesModuleFilter" multiple style="width: 120px; height: 80px;">
            <option value="">Loading modules...</option>
          </select>
        </div>
        <div>
          <label style="font-weight: bold; display: block;">Function</label>
          <select id="rolesFunctionFilter" multiple style="width: 120px; height: 80px;">
            <option value="">Loading functions...</option>
          </select>
        </div>
        <div>
          <label style="font-weight: bold; display: block;">Workflow</label>
          <select id="rolesWorkflowFilter" multiple style="width: 120px; height: 80px;">
            <option value="">Loading workflows...</option>
          </select>
        </div>
        <div>
          <label style="font-weight: bold; display: block;">Last Name</label>
          <select id="rolesLastNameFilter" multiple style="width: 120px; height: 80px;">
            <option value="">Loading names...</option>
          </select>
        </div>
        <div style="align-self: flex-end;">
          <button onclick="loadRoles(1)">Apply Filters</button>
          <button onclick="clearRolesFilters()">Clear</button>
        </div>
      </div>
      <div id="rolesPagination" style="margin-bottom: 10px;"></div>
    </div>
    
    <div class="results">
      <h3>Roles, Workflows & User Assignments</h3>
      <div id="rolesResults">Loading roles...</div>
    </div>
  </div>
    </div>
  </div>

  <div id="workflowOpenPage" class="page">
    <div class="query-section">
      <h3 id="workflowTitle">Workflow Details</h3>
      <button onclick="showWorkflowsPage()">‚Üê Back to Workflows</button>
    </div>
    
    <div class="results">
      <div class="workflow-tabs">
        <button class="tab-button active" onclick="showWorkflowTab('details')">Details</button>
        <button class="tab-button" onclick="showWorkflowTab('activities')">Activities</button>
        <button class="tab-button" id="tasksTabBtn" onclick="showWorkflowTab('tasks')">Tasks</button>
        <button class="tab-button" onclick="showWorkflowTab('performance')">Performance</button>
      </div>
      
      <div id="workflowDetailsTab" class="tab-content active">
        <h4>Workflow Information</h4>
        <div id="workflowDetails">Loading workflow details...</div>
      </div>
      
      <div id="workflowActivitiesTab" class="tab-content">
        <h4>Workflow Activities</h4>
        <div id="workflowActivities">Loading activities...</div>
      </div>
      
      <div id="workflowTasksTab" class="tab-content">
        <h4>Workflow Tasks</h4>
        <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
          <input type="date" id="tasksFromDate" style="width: 150px;" placeholder="From Date">
          <input type="date" id="tasksThruDate" style="width: 150px;" placeholder="Thru Date">
          <select id="activityFilter" style="width: 150px;">
            <option value="">All Activities</option>
          </select>
          <input type="number" id="notesCountFilter" style="width: 120px;" placeholder="Internal Replies > X" min="0">
          <input type="number" id="customerRepliesFilter" style="width: 120px;" placeholder="Customer Replies > X" min="0">
          <select id="sentimentFilter" style="width: 120px;">
            <option value="">All Sentiments</option>
            <option value="Positive">Positive</option>
            <option value="Negative">Negative</option>
            <option value="Neutral">Neutral</option>
          </select>
          <input type="text" id="subjectFilter" style="width: 150px;" placeholder="Subject equals...">
          <label><input type="checkbox" id="subjectContains"> Contains</label>
          <button onclick="loadWorkflowTasks(currentWorkflowId, 1)">Apply Filters</button>
          <button onclick="clearTasksFilters()">Clear</button>
        </div>
        <div id="workflowTasksPagination" style="margin-bottom: 10px;"></div>
        <div id="workflowTasks">Click to load tasks...</div>
      </div>
      
      <div id="workflowPerformanceTab" class="tab-content">
        <h4>Workflow Performance</h4>
        <div style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center;">
          <label style="font-weight: bold;">From:</label>
          <input type="date" id="performanceFromDate" onchange="loadPerformanceCharts()" style="padding: 5px;">
          <label style="font-weight: bold;">To:</label>
          <input type="date" id="performanceToDate" onchange="loadPerformanceCharts()" style="padding: 5px;">
          <button onclick="loadPerformanceCharts()">Refresh</button>
        </div>
        <div style="width: 100%; position: relative; margin-bottom: 30px;">
          <h4>Emails Per Day</h4>
          <canvas id="notesPerDayChart" width="1000" height="400"></canvas>
          <div id="notesLoading" class="chart-loading" style="display: none;">
            <div class="spinner"></div>
            <div style="margin-top: 10px; color: #666;">Loading...</div>
          </div>
        </div>
        <div style="width: 100%; position: relative; margin-bottom: 30px;">
          <h4>Average Reply Time Per Day</h4>
          <canvas id="timeToReplyChart" width="1000" height="400"></canvas>
          <div id="timeToReplyLoading" class="chart-loading" style="display: none;">
            <div class="spinner"></div>
            <div style="margin-top: 10px; color: #666;">Loading...</div>
          </div>
        </div>
        <div style="width: 100%; position: relative; margin-bottom: 30px;">
          <h4>Mail Actions</h4>
          <canvas id="mailActionsChart" width="1000" height="400"></canvas>
          <div id="mailActionsLoading" class="chart-loading" style="display: none;">
            <div class="spinner"></div>
            <div style="margin-top: 10px; color: #666;">Loading...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="workflowTaskOpenPage" class="page">
    <div class="query-section">
      <h3 id="workflowTaskTitle">Workflow Task Details</h3>
      <button onclick="document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById('workflowOpenPage').classList.add('active'); showWorkflowTab('tasks');">‚Üê Back to Tasks</button>
    </div>
    
    <div class="results">
      <h4>Task Information</h4>
      <div id="workflowTaskDetails">Loading task details...</div>
      
      <div class="sms-section" style="margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background: #f9f9f9;">
        <h4>Send Text Message (to 515-201-9881)</h4>
        <div style="margin-bottom: 10px;">
          <label>Message:</label><br>
          <textarea id="smsMessage" rows="3" style="width: calc(100% - 12px); margin-top: 5px; padding: 5px; border: 1px solid #ddd; border-radius: 3px; font-family: Arial, sans-serif; resize: vertical; box-sizing: border-box;" placeholder="Type your message..." spellcheck="true"></textarea>
        </div>
        <button onclick="sendSMS()" style="background: #007cba; color: white; border: none; padding: 8px 16px; border-radius: 3px; cursor: pointer;">Send Text</button>
      </div>
      
      <h4>Replies (Chronological Order)</h4>
      <div id="workflowTaskReplies">Loading replies...</div>
    </div>
  </div>

  <!-- Modal for displaying body content -->
  <div id="bodyModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeBodyModal()">&times;</span>
      <h3 id="modalTitle">Content</h3>
      <div id="modalBody" style="white-space: pre-wrap; border: 1px solid #ddd; padding: 15px; background: #f9f9f9;"></div>
    </div>
  </div>
  
  <!-- Modal for displaying source search results -->
  <div id="sourceSearchModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeSourceSearchModal()">&times;</span>
      <h3 id="sourceSearchTitle">Source Code Search Results</h3>
      <div id="sourceSearchBody" style="max-height: 600px; overflow-y: auto;"></div>
    </div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');
    
    // Load context on page load
    window.addEventListener('DOMContentLoaded', async () => {
      await updateContext();
    });
    
    async function updateContext() {
      try {
        const context = await ipcRenderer.invoke('get-context');
        document.getElementById('currentDatabase').textContent = context.database || 'Not connected';
        document.getElementById('currentTenant').textContent = context.tenant ? 
          `${context.tenant.name} (ID: ${context.tenant.id})` : 'None selected';
        document.getElementById('headerConnectionInfo').textContent = 
          `Connected to ${context.database || 'database'}`;
      } catch (error) {
        console.error('Failed to load context:', error);
      }
    }
    
    function toggleMenu(menuId) {
      const menu = document.getElementById(menuId);
      const isVisible = menu.style.display === 'block';
      
      // Hide all dropdowns
      document.querySelectorAll('.dropdown').forEach(d => d.style.display = 'none');
      
      // Show clicked menu if it wasn't visible
      if (!isVisible) {
        menu.style.display = 'block';
      }
    }
    
    // Close dropdowns when clicking elsewhere
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.menu-item')) {
        closeAllMenus();
      }
    });
    
    function closeAllMenus() {
      document.querySelectorAll('.dropdown').forEach(d => d.style.display = 'none');
    }
    
    function toggleDevTools() {
      const { ipcRenderer } = require('electron');
      ipcRenderer.invoke('toggle-dev-tools');
    }
    
    function createTable(data) {
      if (!data || data.length === 0) return '';
      
      const headers = Object.keys(data[0]);
      let html = '<table><thead><tr>';
      
      headers.forEach(header => {
        html += `<th>${header}</th>`;
      });
      html += '</tr></thead><tbody>';
      
      data.forEach(row => {
        html += '<tr>';
        headers.forEach(header => {
          const value = row[header] !== null ? row[header] : 'NULL';
          html += `<td>${value}</td>`;
        });
        html += '</tr>';
      });
      
      html += '</tbody></table>';
      return html;
    }
    
    function createTenantsTable(data) {
      if (!data || data.length === 0) return '';
      
      const headers = Object.keys(data[0]);
      let html = '<table><thead><tr><th>Action</th>';
      
      headers.forEach(header => {
        html += `<th>${header}</th>`;
      });
      html += '</tr></thead><tbody>';
      
      data.forEach(row => {
        html += '<tr>';
        html += `<td><button onclick="setTenant(${row.Id}, '${row.Name}')">Set as Current</button></td>`;
        headers.forEach(header => {
          const value = row[header] !== null ? row[header] : 'NULL';
          html += `<td>${value}</td>`;
        });
        html += '</tr>';
      });
      
      html += '</tbody></table>';
      return html;
    }
    
    async function setTenant(tenantId, tenantName) {
      try {
        await ipcRenderer.invoke('set-tenant', tenantId, tenantName);
        alert(`Current tenant set to: ${tenantName} (ID: ${tenantId})`);
        showHomePage();
      } catch (error) {
        alert(`Failed to set tenant: ${error.message}`);
      }
    }
    
    function showHomePage() {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('homePage').classList.add('active');
      closeAllMenus();
      updateContext();
    }
    
    function showTenantsPage() {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('tenantsPage').classList.add('active');
      document.querySelectorAll('.dropdown').forEach(d => d.style.display = 'none');
      loadTenants();
    }
    
    async function loadTenants() {
      const resultsDiv = document.getElementById('tenantsResults');
      resultsDiv.innerHTML = 'Loading tenants...';
      
      try {
        const result = await ipcRenderer.invoke('execute-query', 
          `SELECT Id, Name, DefaultColor, DefaultPrimaryColor, 
                  CASE WHEN UseLightTheme = 1 THEN 'Yes' ELSE 'No' END as UseLightTheme,
                  CreatedById, CreatedDate, UpdatedById, UpdatedDate,
                  CASE WHEN IsDeleted = 1 THEN 'Yes' ELSE 'No' END as IsDeleted
           FROM Tenants 
           WHERE IsDeleted = 0
           ORDER BY Id`);
        
        if (result.success) {
          if (result.data && result.data.length > 0) {
            const table = createTenantsTable(result.data);
            resultsDiv.innerHTML = `<p>${result.data.length} active tenants found.</p>${table}`;
          } else {
            resultsDiv.innerHTML = '<p>No active tenants found.</p>';
          }
        } else {
          resultsDiv.innerHTML = `<div class="error">Failed to load tenants: ${result.error}</div>`;
        }
      } catch (error) {
        resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
      }
    }
    
    async function loadAllTenants() {
      const resultsDiv = document.getElementById('tenantsResults');
      resultsDiv.innerHTML = 'Loading all tenants...';
      
      try {
        const result = await ipcRenderer.invoke('execute-query', 
          `SELECT Id, Name, DefaultColor, DefaultPrimaryColor, 
                  CASE WHEN UseLightTheme = 1 THEN 'Yes' ELSE 'No' END as UseLightTheme,
                  CreatedById, CreatedDate, UpdatedById, UpdatedDate,
                  CASE WHEN IsDeleted = 1 THEN 'Yes' ELSE 'No' END as IsDeleted,
                  DeletedDate
           FROM Tenants 
           ORDER BY IsDeleted, Id`);
        
        if (result.success) {
          if (result.data && result.data.length > 0) {
            const table = createTable(result.data);
            resultsDiv.innerHTML = `<p>${result.data.length} total tenants found.</p>${table}`;
          } else {
            resultsDiv.innerHTML = '<p>No tenants found.</p>';
          }
        } else {
          resultsDiv.innerHTML = `<div class="error">Failed to load tenants: ${result.error}</div>`;
        }
      } catch (error) {
        resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
      }
    }
    
    function showWorkflowsPage() {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('workflowsPage').classList.add('active');
      document.querySelectorAll('.dropdown').forEach(d => d.style.display = 'none');
      updateWorkflowsContext();
    }
    
    async function updateWorkflowsContext() {
      try {
        const context = await ipcRenderer.invoke('get-context');
        const tenantInfo = document.getElementById('workflowTenantInfo');
        const refreshBtn = document.getElementById('refreshWorkflowsBtn');
        
        if (context.tenant) {
          tenantInfo.textContent = `Showing workflows for: ${context.tenant.name} (ID: ${context.tenant.id})`;
          refreshBtn.disabled = false;
          loadWorkflows();
        } else {
          tenantInfo.textContent = 'No tenant selected. Please select a tenant first.';
          refreshBtn.disabled = true;
          document.getElementById('workflowsResults').innerHTML = 'Select a tenant to view workflows.';
        }
      } catch (error) {
        console.error('Failed to load context:', error);
      }
    }
    
    async function loadWorkflows() {
      const resultsDiv = document.getElementById('workflowsResults');
      
      try {
        const context = await ipcRenderer.invoke('get-context');
        if (!context.tenant) {
          resultsDiv.innerHTML = '<div class="error">No tenant selected</div>';
          return;
        }
        
        resultsDiv.innerHTML = 'Loading workflows...';
        
        const result = await ipcRenderer.invoke('execute-query', 
          `SELECT Id, Name, 
                  CASE WHEN SyncEnabled = 1 THEN 'Yes' ELSE 'No' END as SyncEnabled,
                  CASE WHEN IsRouter = 1 THEN 'Yes' ELSE 'No' END as IsRouter,
                  CASE WHEN IsRoutable = 1 THEN 'Yes' ELSE 'No' END as IsRoutable,
                  CASE WHEN IsReRouteAllowed = 1 THEN 'Yes' ELSE 'No' END as IsReRouteAllowed,
                  EmailUserName, EmailMailboxOwner,
                  CreatedById, CreatedDate, UpdatedById, UpdatedDate
           FROM Workflows 
           WHERE TenantId = ${context.tenant.id} AND IsDeleted = 0
           ORDER BY Name`);
        
        if (result.success) {
          if (result.data && result.data.length > 0) {
            const table = createWorkflowsTable(result.data);
            resultsDiv.innerHTML = `<p>${result.data.length} workflows found for tenant ${context.tenant.name}.</p>${table}`;
          } else {
            resultsDiv.innerHTML = `<p>No workflows found for tenant ${context.tenant.name}.</p>`;
          }
        } else {
          resultsDiv.innerHTML = `<div class="error">Failed to load workflows: ${result.error}</div>`;
        }
      } catch (error) {
        resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
      }
    }
    
    function createWorkflowsTable(data) {
      if (!data || data.length === 0) return '';
      
      const headers = Object.keys(data[0]);
      let html = '<table><thead><tr><th>Action</th>';
      
      headers.forEach(header => {
        html += `<th>${header}</th>`;
      });
      html += '</tr></thead><tbody>';
      
      data.forEach(row => {
        html += '<tr>';
        html += `<td><button onclick="openWorkflow(${row.Id}, '${row.Name}')">Open</button></td>`;
        headers.forEach(header => {
          const value = row[header] !== null ? row[header] : 'NULL';
          html += `<td>${value}</td>`;
        });
        html += '</tr>';
      });
      
      html += '</tbody></table>';
      return html;
    }
    
    async function openWorkflow(workflowId, workflowName) {
      currentWorkflowId = workflowId;
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('workflowOpenPage').classList.add('active');
      document.getElementById('workflowTitle').textContent = `Workflow: ${workflowName} (${workflowId})`;
      
      // Reset to details tab
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.getElementById('workflowDetailsTab').classList.add('active');
      document.querySelector('.tab-button').classList.add('active');
      
      await loadWorkflowDetails(workflowId);
      await loadWorkflowActivities(workflowId);
      await loadTasksCount(workflowId);
    }
    
    async function loadWorkflowDetails(workflowId) {
      const detailsDiv = document.getElementById('workflowDetails');
      detailsDiv.innerHTML = 'Loading workflow details...';
      
      try {
        const result = await ipcRenderer.invoke('execute-query', 
          `SELECT Id, TenantId, Name, EmailSignature, EmailUserName, EmailMailboxOwner,
                  CASE WHEN SyncEnabled = 1 THEN 'Yes' ELSE 'No' END as SyncEnabled,
                  CASE WHEN IsRouter = 1 THEN 'Yes' ELSE 'No' END as IsRouter,
                  CASE WHEN IsRoutable = 1 THEN 'Yes' ELSE 'No' END as IsRoutable,
                  CASE WHEN IsReRouteAllowed = 1 THEN 'Yes' ELSE 'No' END as IsReRouteAllowed,
                  CreatedById, CreatedDate, UpdatedById, UpdatedDate
           FROM Workflows 
           WHERE Id = ${workflowId}`);
        
        if (result.success && result.data && result.data.length > 0) {
          const grid = createWorkflowDetailsGrid(result.data[0]);
          detailsDiv.innerHTML = grid;
        } else {
          detailsDiv.innerHTML = '<div class="error">Workflow not found</div>';
        }
      } catch (error) {
        detailsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
      }
    }
    
    async function loadWorkflowActivities(workflowId) {
      const activitiesDiv = document.getElementById('workflowActivities');
      activitiesDiv.innerHTML = 'Loading activities...';
      
      try {
        const result = await ipcRenderer.invoke('execute-query', 
          `SELECT wa.Id, wa.Name, sv.Name as ActivityType, wa.Position,
                  wa.ServiceLevelAgreementTicks,
                  CASE WHEN wa.RequireSubcategoryWhenCategorySelected = 1 THEN 'Yes' ELSE 'No' END as RequireSubcategory,
                  wa.CreatedById, wa.CreatedDate, wa.UpdatedById, wa.UpdatedDate
           FROM WorkflowActivities wa
           LEFT JOIN SystemValues sv ON wa.ActivityTypeValueId = sv.Id
           WHERE wa.WorkflowId = ${workflowId} AND wa.IsDeleted = 0
           ORDER BY wa.Position`);
        
        if (result.success) {
          if (result.data && result.data.length > 0) {
            const table = createActivitiesTable(result.data, workflowId);
            activitiesDiv.innerHTML = `<p>${result.data.length} activities found.</p>${table}`;
          } else {
            activitiesDiv.innerHTML = '<p>No activities found for this workflow.</p>';
          }
        } else {
          activitiesDiv.innerHTML = `<div class="error">Failed to load activities: ${result.error}</div>`;
        }
      } catch (error) {
        activitiesDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
      }
    }
    
    function createActivitiesTable(activities, workflowId) {
      if (!activities || activities.length === 0) return '';
      
      let html = '';
      
      activities.forEach(activity => {
        html += `<div style="margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 5px;">`;
        html += `<h5>Activity: ${activity.Name} (Position: ${activity.Position})</h5>`;
        html += `<p><strong>Type:</strong> ${activity.ActivityType || 'Unknown'} | <strong>SLA Ticks:</strong> ${activity.ServiceLevelAgreementTicks || 'None'}</p>`;
        html += `<p><strong>Require Subcategory:</strong> ${activity.RequireSubcategory}</p>`;
        html += `<div id="roles_${activity.Id}" style="margin-top: 10px;">Loading roles...</div>`;
        html += `<div id="actions_${activity.Id}" style="margin-top: 10px;">Loading actions...</div>`;
        html += `</div>`;
      });
      
      // Load roles and actions for each activity
      setTimeout(() => {
        activities.forEach(activity => {
          loadActivityRoles(activity.Id);
          loadActivityActions(activity.Id);
        });
      }, 100);
      
      return html;
    }
    
    async function loadActivityActions(activityId) {
      const actionsDiv = document.getElementById(`actions_${activityId}`);
      
      try {
        const result = await ipcRenderer.invoke('execute-query', 
          `SELECT waa.Id, waa.Label, sv.Name as ActionType, waa.Position,
                  waa.CreatedById, waa.CreatedDate, waa.UpdatedById, waa.UpdatedDate
           FROM WorkflowActivityAction waa
           LEFT JOIN SystemValues sv ON waa.WorkflowActivityActionValueId = sv.Id
           WHERE waa.WorkflowActivityId = ${activityId} AND waa.IsDeleted = 0
           ORDER BY waa.Position`);
        
        if (result.success) {
          if (result.data && result.data.length > 0) {
            let actionsHtml = '<strong>Actions:</strong><table style="margin-top: 5px; font-size: 11px;"><thead><tr>';
            const headers = Object.keys(result.data[0]);
            headers.forEach(header => {
              actionsHtml += `<th>${header}</th>`;
            });
            actionsHtml += '</tr></thead><tbody>';
            
            result.data.forEach(row => {
              actionsHtml += '<tr>';
              headers.forEach(header => {
                const value = row[header] !== null ? row[header] : 'NULL';
                actionsHtml += `<td>${value}</td>`;
              });
              actionsHtml += '</tr>';
            });
            actionsHtml += '</tbody></table>';
            
            actionsDiv.innerHTML = actionsHtml;
          } else {
            actionsDiv.innerHTML = '<em>No actions defined for this activity.</em>';
          }
        } else {
          actionsDiv.innerHTML = `<em>Error loading actions: ${result.error}</em>`;
        }
      } catch (error) {
        actionsDiv.innerHTML = `<em>Error: ${error.message}</em>`;
      }
    }
    
    async function loadActivityRoles(activityId) {
      const rolesDiv = document.getElementById(`roles_${activityId}`);
      
      try {
        const result = await ipcRenderer.invoke('execute-query', 
          `SELECT war.Id, war.RoleId,
                  war.CreatedById, war.CreatedDate, war.UpdatedById, war.UpdatedDate
           FROM WorkflowActivityRole war
           WHERE war.WorkflowActivityId = ${activityId} AND war.IsDeleted = 0
           ORDER BY war.RoleId`);
        
        if (result.success) {
          if (result.data && result.data.length > 0) {
            let rolesHtml = '<strong>Roles:</strong><table style="margin-top: 5px; font-size: 11px;"><thead><tr>';
            const headers = Object.keys(result.data[0]);
            headers.forEach(header => {
              rolesHtml += `<th>${header}</th>`;
            });
            rolesHtml += '</tr></thead><tbody>';
            
            result.data.forEach(row => {
              rolesHtml += '<tr>';
              headers.forEach(header => {
                const value = row[header] !== null ? row[header] : 'NULL';
                rolesHtml += `<td>${value}</td>`;
              });
              rolesHtml += '</tr>';
            });
            rolesHtml += '</tbody></table>';
            
            rolesDiv.innerHTML = rolesHtml;
          } else {
            rolesDiv.innerHTML = '<em>No roles assigned to this activity.</em>';
          }
        } else {
          rolesDiv.innerHTML = `<em>Error loading roles: ${result.error}</em>`;
        }
      } catch (error) {
        rolesDiv.innerHTML = `<em>Error: ${error.message}</em>`;
      }
    }
    
    function showUserTrackingPage() {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('userTrackingPage').classList.add('active');
      document.querySelectorAll('.dropdown').forEach(d => d.style.display = 'none');
      setDefaultDates();
      loadFilterOptions();
      document.getElementById('userTrackingResults').innerHTML = 'Apply filters to load data.';
    }
    
    function setDefaultDates() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('dateFromFilter').value = today;
      document.getElementById('dateThroughFilter').value = today;
    }
    
    let allFunctions = [];
    
    async function loadFilterOptions() {
      try {
        // Load modules
        const modules = await ipcRenderer.invoke('execute-query', 'SELECT DISTINCT sm.name FROM SystemModules sm ORDER BY sm.name');
        populateSelect('moduleFilter', modules.data, 'name');
        
        // Load all functions with module info
        const functions = await ipcRenderer.invoke('execute-query', 'SELECT DISTINCT sf.Name, sm.name as ModuleName FROM systemfunctions sf INNER JOIN SystemModules sm ON sm.id = sf.SystemModuleId ORDER BY sf.Name');
        allFunctions = functions.data || [];
        populateSelect('functionFilter', allFunctions, 'Name');
        
        // Load tenants
        const tenants = await ipcRenderer.invoke('execute-query', 'SELECT DISTINCT t.name FROM Tenants t ORDER BY t.name');
        populateSelect('tenantFilter', tenants.data, 'name');
        

      } catch (error) {
        console.error('Failed to load filter options:', error);
      }
    }
    
    function filterFunctionsByModule() {
      const selectedModules = getSelectedValues('moduleFilter');
      const functionSelect = document.getElementById('functionFilter');
      
      functionSelect.innerHTML = '';
      
      if (selectedModules.length === 0) {
        // Show all functions if no modules selected
        allFunctions.forEach(func => {
          const option = document.createElement('option');
          option.value = func.Name;
          option.textContent = func.Name;
          functionSelect.appendChild(option);
        });
      } else {
        // Show only functions from selected modules
        const filteredFunctions = allFunctions.filter(func => selectedModules.includes(func.ModuleName));
        filteredFunctions.forEach(func => {
          const option = document.createElement('option');
          option.value = func.Name;
          option.textContent = func.Name;
          functionSelect.appendChild(option);
        });
      }
    }
    
    function populateSelect(selectId, data, fieldName) {
      const select = document.getElementById(selectId);
      select.innerHTML = '';
      
      if (data && data.length > 0) {
        data.forEach(item => {
          const option = document.createElement('option');
          option.value = item[fieldName];
          option.textContent = item[fieldName];
          select.appendChild(option);
        });
      }
    }
    
    function getSelectedValues(selectId) {
      const select = document.getElementById(selectId);
      return Array.from(select.selectedOptions).map(option => option.value);
    }
    
    let currentTrackingPage = 1;
    let trackingSortField = 'sut.Id';
    let trackingSortOrder = 'DESC';
    
    async function loadUserTracking(page = 1) {
      currentTrackingPage = page;
      const resultsDiv = document.getElementById('userTrackingResults');
      const paginationDiv = document.getElementById('trackingPagination');
      
      const moduleFilter = getSelectedValues('moduleFilter');
      const functionFilter = getSelectedValues('functionFilter');
      const tenantFilter = getSelectedValues('tenantFilter');
      const dateFrom = document.getElementById('dateFromFilter').value;
      const dateThrough = document.getElementById('dateThroughFilter').value;
      
      let whereClause = 'WHERE 1=1';
      if (moduleFilter.length > 0) {
        const moduleList = moduleFilter.map(m => `'${m}'`).join(',');
        whereClause += ` AND sm.name IN (${moduleList})`;
      }
      if (functionFilter.length > 0) {
        const functionList = functionFilter.map(f => `'${f}'`).join(',');
        whereClause += ` AND sf.Name IN (${functionList})`;
      }
      if (tenantFilter.length > 0) {
        const tenantList = tenantFilter.map(t => `'${t}'`).join(',');
        whereClause += ` AND t.name IN (${tenantList})`;
      }
      if (dateFrom) {
        whereClause += ` AND sut.CreatedDate >= '${dateFrom}'`;
      }
      if (dateThrough) {
        whereClause += ` AND sut.CreatedDate <= '${dateThrough} 23:59:59'`;
      }
      
      const offset = (page - 1) * 100;
      
      resultsDiv.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="spinner"></div><p>Loading user tracking data...</p></div>';
      
      try {
        const result = await ipcRenderer.invoke('execute-query', 
          `SELECT TOP 100 * FROM (
             SELECT ROW_NUMBER() OVER (ORDER BY ${trackingSortField} ${trackingSortOrder}) as RowNum,
                    sm.name as [Module], sf.Name as [Function], t.name as [Tenant],
                    a.AccountId as [Account], p.FirstName + ' ' + p.LastName as [User],
                    sut.[Path], sut.[Data], sut.CreatedDate
             FROM SystemUserTrackings sut
             INNER JOIN People p ON p.applicationuserid = sut.Createdbyid
             INNER JOIN Accounts a ON a.id = p.AccountId
             INNER JOIN Tenants t ON t.id = a.TenantId
             INNER JOIN systemfunctions sf ON sf.id = sut.FunctionId
             INNER JOIN SystemModules sm ON sm.id = sf.SystemModuleId
             ${whereClause}
           ) AS NumberedResults
           WHERE RowNum > ${offset}
           ORDER BY RowNum`);
        
        if (result.success) {
          if (result.data && result.data.length > 0) {
            const table = createSortableTable(result.data, 'tracking');
            resultsDiv.innerHTML = table;
            
            // Update pagination
            const hasMore = result.data.length === 100;
            updatePagination(page, hasMore, 'loadUserTracking');
            
            // Load chart data
            await loadAllCharts();
          } else {
            resultsDiv.innerHTML = '<p>No user tracking data found.</p>';
            paginationDiv.innerHTML = '';
            // Clear charts when no data
            clearAllCharts();
          }
        } else {
          resultsDiv.innerHTML = `<div class="error">Failed to load user tracking: ${result.error}</div>`;
        }
      } catch (error) {
        resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
      }
    }
    
    function createSortableTable(data, tableType) {
      if (!data || data.length === 0) return '';
      
      let headers = Object.keys(data[0]);
      
      // Hide specific columns for workflow tasks
      if (tableType === 'workflowTasks') {
        headers = headers.filter(h => !['ServiceLevelAgreementTicks', 'SlaCalculationDate', 'SlaSeconds', 'CreatedDate', 'Id', 'RowNum'].includes(h));
      }
      
      let tableClass = '';
      if (tableType === 'logs') tableClass = 'logs-table';
      if (tableType === 'tracking') tableClass = 'tracking-table';
      let html = `<table class="${tableClass}"><thead><tr>`;
      
      headers.forEach(header => {
        let colClass = '';
        if (tableType === 'logs') {
          if (header === 'Description') colClass = 'description-col';
          if (header === 'Summary') colClass = 'summary-col';
        }
        if (tableType === 'tracking') {
          if (header === 'Data') colClass = 'data-col';
          if (header === 'Path') colClass = 'path-col';
        }
        html += `<th class="${colClass}" style="cursor: pointer;" onclick="sortTable('${header}', '${tableType}')">${header} ‚Üï</th>`;
      });
      html += '</tr></thead><tbody>';
      
      data.forEach(row => {
        html += '<tr>';
        headers.forEach(header => {
          let colClass = '';
          if (tableType === 'logs') {
            if (header === 'Description') colClass = 'description-col';
            if (header === 'Summary') colClass = 'summary-col';
          }
          if (tableType === 'tracking') {
            if (header === 'Data') colClass = 'data-col';
            if (header === 'Path') colClass = 'path-col';
          }
          
          let value = row[header] !== null ? row[header] : 'NULL';
          
          // Format UpdatedDate for workflow tasks
          if (tableType === 'workflowTasks' && header === 'UpdatedDate' && value !== 'NULL' && value !== null) {
            const date = new Date(value);
            value = `${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}/${date.getFullYear()} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
          }
          
          // Make WorkflowTaskId clickable if it has a value and we're on workflow tasks page
          if (tableType === 'workflowTasks' && header === 'WorkflowTaskId' && value !== 'NULL' && value !== null) {
            value = `<a href="#" onclick="openWorkflowTask(${value})" style="color: blue; text-decoration: underline;">${value}</a>`;
          }
          
          // Make WorkflowId clickable if it has a value and we're on roles page
          if (tableType === 'roles' && header === 'WorkflowId' && value !== 'NULL' && value !== null) {
            value = `<a href="#" onclick="openWorkflowFromRoles(${value}, '${row.Workflow}')" style="color: blue; text-decoration: underline;">${value}</a>`;
          }
          
          // Make Summary clickable for logs
          if (tableType === 'logs' && header === 'Summary' && value !== 'NULL' && value !== null) {
            const escapedValue = value.replace(/'/g, "&#39;").replace(/"/g, "&quot;");
            value = `<a href="#" onclick="searchInSource('${escapedValue}')" style="color: blue; text-decoration: underline; cursor: pointer;">${value}</a>`;
          }
          
          // Make Origin clickable for logs
          if (tableType === 'logs' && header === 'Origin' && value !== 'NULL' && value !== null) {
            const escapedValue = value.replace(/'/g, "&#39;").replace(/"/g, "&quot;");
            value = `<a href="#" onclick="searchInSource('${escapedValue}')" style="color: blue; text-decoration: underline; cursor: pointer;">${value}</a>`;
          }
          
          // Color code LogLevel cells
          if (tableType === 'logs' && header === 'LogLevel' && value !== 'NULL' && value !== null) {
            const colors = {
              'Trace': '#6c757d',
              'Debug': '#17a2b8', 
              'Information': '#28a745',
              'Warning': '#ffc107',
              'Error': '#dc3545',
              'Critical': '#6f42c1'
            };
            const color = colors[value] || '#333';
            value = `<span style="background: ${color}; color: white; padding: 4px 8px; border-radius: 3px; font-weight: bold;">${value}</span>`;
          }
          
          // Make Path clickable for user tracking
          if (tableType === 'tracking' && header === 'Path' && value !== 'NULL' && value !== null) {
            const escapedValue = value.replace(/'/g, "&#39;").replace(/"/g, "&quot;");
            value = `<a href="#" onclick="openExternalUrl('${escapedValue}')" style="color: blue; text-decoration: underline; cursor: pointer;">${value}</a>`;
          }
          

          
          html += `<td class="${colClass}" title="${row[header]}">${value}</td>`;
        });
        html += '</tr>';
      });
      
      html += '</tbody></table>';
      return html;
    }
    
    function sortTable(field, tableType) {
      if (tableType === 'tracking') {
        trackingSortOrder = (trackingSortField === field && trackingSortOrder === 'ASC') ? 'DESC' : 'ASC';
        trackingSortField = field;
        loadUserTracking(currentTrackingPage);
      }
    }
    
    function updatePagination(currentPage, hasMore, loadFunction) {
      const paginationDiv = document.getElementById('trackingPagination');
      let html = `Page ${currentPage} `;
      
      if (currentPage > 1) {
        html += `<button onclick="${loadFunction}(${currentPage - 1})">Previous</button> `;
      }
      
      if (hasMore) {
        html += `<button onclick="${loadFunction}(${currentPage + 1})">Next</button>`;
      }
      
      paginationDiv.innerHTML = html;
    }
    
    function clearFilters() {
      document.getElementById('moduleFilter').selectedIndex = -1;
      document.getElementById('functionFilter').selectedIndex = -1;
      document.getElementById('tenantFilter').selectedIndex = -1;
      setDefaultDates();
      loadUserTracking(1);
    }
    
    function getWhereClause() {
      const moduleFilter = getSelectedValues('moduleFilter');
      const functionFilter = getSelectedValues('functionFilter');
      const tenantFilter = getSelectedValues('tenantFilter');
      const dateFrom = document.getElementById('dateFromFilter').value;
      const dateThrough = document.getElementById('dateThroughFilter').value;
      
      let whereClause = 'WHERE 1=1';
      if (moduleFilter.length > 0) {
        const moduleList = moduleFilter.map(m => `'${m}'`).join(',');
        whereClause += ` AND sm.name IN (${moduleList})`;
      }
      if (functionFilter.length > 0) {
        const functionList = functionFilter.map(f => `'${f}'`).join(',');
        whereClause += ` AND sf.Name IN (${functionList})`;
      }
      if (tenantFilter.length > 0) {
        const tenantList = tenantFilter.map(t => `'${t}'`).join(',');
        whereClause += ` AND t.name IN (${tenantList})`;
      }
      if (dateFrom) {
        whereClause += ` AND sut.CreatedDate >= '${dateFrom}'`;
      }
      if (dateThrough) {
        whereClause += ` AND sut.CreatedDate <= '${dateThrough} 23:59:59'`;
      }
      return whereClause;
    }
    
    async function loadAllCharts() {
      const whereClause = getWhereClause();
      
      try {
        // Functions chart
        const functionsResult = await ipcRenderer.invoke('execute-query', 
          `SELECT TOP 10 sf.Name as [Function], COUNT(*) as [Count]
           FROM SystemUserTrackings sut
           INNER JOIN People p ON p.applicationuserid = sut.Createdbyid
           INNER JOIN Accounts a ON a.id = p.AccountId
           INNER JOIN Tenants t ON t.id = a.TenantId
           INNER JOIN systemfunctions sf ON sf.id = sut.FunctionId
           INNER JOIN SystemModules sm ON sm.id = sf.SystemModuleId
           ${whereClause}
           GROUP BY sf.Name
           ORDER BY COUNT(*) DESC`);
        
        if (functionsResult.success && functionsResult.data) {
          drawPieChart(functionsResult.data, 'functionsChart');
          addChartTooltips('functionsChart', functionsResult.data, 'pie', 'Function');
        }
        
        // Paths chart
        const pathsResult = await ipcRenderer.invoke('execute-query', 
          `SELECT TOP 10 sut.[Path], COUNT(*) as [Count]
           FROM SystemUserTrackings sut
           INNER JOIN People p ON p.applicationuserid = sut.Createdbyid
           INNER JOIN Accounts a ON a.id = p.AccountId
           INNER JOIN Tenants t ON t.id = a.TenantId
           INNER JOIN systemfunctions sf ON sf.id = sut.FunctionId
           INNER JOIN SystemModules sm ON sm.id = sf.SystemModuleId
           ${whereClause}
           GROUP BY sut.[Path]
           ORDER BY COUNT(*) DESC`);
        
        if (pathsResult.success && pathsResult.data) {
          drawBarChart(pathsResult.data, 'pathsChart', 'Path');
          addChartTooltips('pathsChart', pathsResult.data, 'bar', 'Path');
        }
        
        // Modules chart
        const modulesResult = await ipcRenderer.invoke('execute-query', 
          `SELECT TOP 10 sm.name as [Module], COUNT(*) as [Count]
           FROM SystemUserTrackings sut
           INNER JOIN People p ON p.applicationuserid = sut.Createdbyid
           INNER JOIN Accounts a ON a.id = p.AccountId
           INNER JOIN Tenants t ON t.id = a.TenantId
           INNER JOIN systemfunctions sf ON sf.id = sut.FunctionId
           INNER JOIN SystemModules sm ON sm.id = sf.SystemModuleId
           ${whereClause}
           GROUP BY sm.name
           ORDER BY COUNT(*) DESC`);
        
        if (modulesResult.success && modulesResult.data) {
          drawBarChart(modulesResult.data, 'modulesChart', 'Module');
          addChartTooltips('modulesChart', modulesResult.data, 'bar', 'Module');
        }
        
        // Users chart
        const usersResult = await ipcRenderer.invoke('execute-query', 
          `SELECT TOP 10 p.FirstName + ' ' + p.LastName as [User], COUNT(*) as [Count]
           FROM SystemUserTrackings sut
           INNER JOIN People p ON p.applicationuserid = sut.Createdbyid
           INNER JOIN Accounts a ON a.id = p.AccountId
           INNER JOIN Tenants t ON t.id = a.TenantId
           INNER JOIN systemfunctions sf ON sf.id = sut.FunctionId
           INNER JOIN SystemModules sm ON sm.id = sf.SystemModuleId
           ${whereClause}
           GROUP BY p.FirstName, p.LastName
           ORDER BY COUNT(*) DESC`);
        
        if (usersResult.success && usersResult.data) {
          drawBarChart(usersResult.data, 'usersChart', 'User');
          addChartTooltips('usersChart', usersResult.data, 'bar', 'User');
        }
        
      } catch (error) {
        console.error('Failed to load chart data:', error);
      }
    }
    
    function clearAllCharts() {
      ['functionsChart', 'pathsChart', 'modulesChart', 'usersChart'].forEach(canvasId => {
        const canvas = document.getElementById(canvasId);
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      });
    }
    
    function drawPieChart(data, canvasId) {
      const canvas = document.getElementById(canvasId);
      const ctx = canvas.getContext('2d');
      
      // Clear canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      if (!data || data.length === 0) return;
      
      const total = data.reduce((sum, item) => sum + item.Count, 0);
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const radius = Math.min(centerX, centerY) - 20;
      
      let currentAngle = 0;
      const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'];
      
      // Store slice data for tooltip detection
      canvas.sliceData = [];
      
      data.forEach((item, index) => {
        const sliceAngle = (item.Count / total) * 2 * Math.PI;
        
        // Store slice info
        canvas.sliceData.push({
          startAngle: currentAngle,
          endAngle: currentAngle + sliceAngle,
          data: item
        });
        
        // Draw slice
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
        ctx.closePath();
        ctx.fillStyle = colors[index % colors.length];
        ctx.fill();
        
        // Draw label
        const labelAngle = currentAngle + sliceAngle / 2;
        const labelX = centerX + Math.cos(labelAngle) * (radius * 0.7);
        const labelY = centerY + Math.sin(labelAngle) * (radius * 0.7);
        
        ctx.fillStyle = 'white';
        ctx.font = '10px Arial';
        ctx.textAlign = 'center';
        const label = item.Function || item.Module || item.User || item.Path;
        ctx.fillText(label.length > 10 ? label.substring(0, 10) + '...' : label, labelX, labelY);
        ctx.fillText(item.Count, labelX, labelY + 12);
        
        currentAngle += sliceAngle;
      });
    }
    
    function drawBarChart(data, canvasId, labelField) {
      const canvas = document.getElementById(canvasId);
      const ctx = canvas.getContext('2d');
      
      // Clear canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      if (!data || data.length === 0) return;
      
      const maxCount = Math.max(...data.map(item => item.Count));
      const barWidth = (canvas.width - 120) / data.length;
      const maxBarHeight = canvas.height - 150;
      
      const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'];
      
      data.forEach((item, index) => {
        const barHeight = (item.Count / maxCount) * maxBarHeight;
        const x = 60 + index * barWidth;
        const y = canvas.height - 130 - barHeight;
        
        // Draw bar
        ctx.fillStyle = colors[index % colors.length];
        ctx.fillRect(x, y, barWidth - 10, barHeight);
        
        // Draw count on top of bar
        ctx.fillStyle = 'black';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(item.Count, x + barWidth/2, y - 5);
        
        // Draw label at bottom
        ctx.save();
        ctx.translate(x + barWidth/2, canvas.height - 50);
        ctx.rotate(-Math.PI/4);
        ctx.textAlign = 'right';
        ctx.font = '10px Arial';
        const label = item[labelField] || '';
        ctx.fillText(label.length > 15 ? label.substring(0, 15) + '...' : label, 0, 0);
        ctx.restore();
      });
    }
    
    function addChartTooltips(canvasId, data, chartType, labelField) {
      const canvas = document.getElementById(canvasId);
      const tooltip = document.getElementById('chartTooltip');
      
      canvas.addEventListener('mousemove', (e) => {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        let hoveredItem = null;
        
        if (chartType === 'pie') {
          hoveredItem = getPieSliceAt(x, y, data, canvas);
        } else if (chartType === 'bar') {
          hoveredItem = getBarAt(x, y, data, canvas);
        }
        
        if (hoveredItem) {
          const label = hoveredItem[labelField] || hoveredItem.Function || hoveredItem.Module || hoveredItem.User || hoveredItem.Path;
          tooltip.innerHTML = `${label}<br>Count: ${hoveredItem.Count}`;
          tooltip.style.display = 'block';
          tooltip.style.left = (e.clientX + 10) + 'px';
          tooltip.style.top = (e.clientY - 10) + 'px';
        } else {
          tooltip.style.display = 'none';
        }
      });
      
      canvas.addEventListener('mouseleave', () => {
        tooltip.style.display = 'none';
      });
    }
    
    function getPieSliceAt(x, y, data, canvas) {
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const radius = Math.min(centerX, centerY) - 20;
      
      const dx = x - centerX;
      const dy = y - centerY;
      const distance = Math.sqrt(dx * dx + dy * dy);
      
      if (distance > radius || distance < 10) return null;
      
      let angle = Math.atan2(dy, dx);
      if (angle < 0) angle += 2 * Math.PI;
      
      // Use stored slice data for accurate detection
      if (canvas.sliceData) {
        for (let slice of canvas.sliceData) {
          if (angle >= slice.startAngle && angle <= slice.endAngle) {
            return slice.data;
          }
        }
      }
      
      return null;
    }
    
    function getBarAt(x, y, data, canvas) {
      const barWidth = (canvas.width - 120) / data.length;
      const maxBarHeight = canvas.height - 150;
      const maxCount = Math.max(...data.map(item => item.Count));
      
      for (let i = 0; i < data.length; i++) {
        const barHeight = (data[i].Count / maxCount) * maxBarHeight;
        const barX = 60 + i * barWidth;
        const barY = canvas.height - 130 - barHeight;
        
        if (x >= barX && x <= barX + barWidth - 10 && y >= barY && y <= barY + barHeight) {
          return data[i];
        }
      }
      
      return null;
    }
    
    function showLogsPage() {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('logsPage').classList.add('active');
      closeAllMenus();
      setDefaultLogsDates();
      loadLogLevelFilter();
      loadSolutionPath();
      document.getElementById('logsResults').innerHTML = 'Apply filters to load logs.';
    }
    
    async function loadSolutionPath() {
      try {
        const result = await ipcRenderer.invoke('load-solution-path');
        if (result.success) {
          document.getElementById('solutionPath').value = result.path || '';
        }
      } catch (error) {
        console.error('Failed to load solution path:', error);
      }
    }
    
    function browseSolutionPath() {
      const { dialog } = require('electron').remote || require('@electron/remote');
      if (dialog) {
        const result = dialog.showOpenDialogSync({
          properties: ['openDirectory'],
          title: 'Select Solution Directory'
        });
        
        if (result && result.length > 0) {
          document.getElementById('solutionPath').value = result[0];
        }
      } else {
        alert('Directory browser not available. Please enter the path manually.');
      }
    }
    
    async function saveSolutionPath() {
      const path = document.getElementById('solutionPath').value;
      if (!path) {
        alert('Please enter a solution path');
        return;
      }
      
      try {
        const result = await ipcRenderer.invoke('save-solution-path', path);
        if (result.success) {
          alert('Solution path saved successfully!');
        } else {
          alert(`Failed to save solution path: ${result.error}`);
        }
      } catch (error) {
        alert(`Error saving solution path: ${error.message}`);
      }
    }
    
    async function loadLogLevelFilter() {
      try {
        const result = await ipcRenderer.invoke('execute-query', 
          `select Id, Name
           from systemvalues
           where SystemLookupId = '30C60DB9-CEFE-4259-97B3-DC1936EF430D'
           order by Position`);
        
        const select = document.getElementById('logLevelFilter');
        select.innerHTML = '';
        
        if (result.success && result.data) {
          result.data.forEach(item => {
            const option = document.createElement('option');
            option.value = item.Id;
            option.textContent = item.Name;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Failed to load log levels:', error);
      }
    }
    
    function setDefaultLogsDates() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('logsDateFromFilter').value = today;
      document.getElementById('logsDateThroughFilter').value = today;
    }
    
    let currentLogsPage = 1;
    let logsSortField = 'Id';
    let logsSortOrder = 'DESC';
    
    async function loadLogs(page = 1) {
      currentLogsPage = page;
      const resultsDiv = document.getElementById('logsResults');
      const paginationDiv = document.getElementById('logsPagination');
      
      const dateFrom = document.getElementById('logsDateFromFilter').value;
      const dateThrough = document.getElementById('logsDateThroughFilter').value;
      const logLevels = getSelectedValues('logLevelFilter');
      
      let whereClause = 'WHERE Logs.IsDeleted = 0';
      if (dateFrom) {
        whereClause += ` AND Logs.CreatedDate >= '${dateFrom}'`;
      }
      if (dateThrough) {
        whereClause += ` AND Logs.CreatedDate <= '${dateThrough} 23:59:59'`;
      }
      if (logLevels.length > 0) {
        const logLevelList = logLevels.map(l => `'${l}'`).join(',');
        whereClause += ` AND Logs.LogLevel IN (${logLevelList})`;
      }
      
      const offset = (page - 1) * 100;
      
      resultsDiv.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="spinner"></div><p>Loading logs...</p></div>';
      
      try {
        const result = await ipcRenderer.invoke('execute-query', 
          `SELECT TOP 100 * FROM (
             SELECT ROW_NUMBER() OVER (ORDER BY Logs.${logsSortField} ${logsSortOrder}) as RowNum,
                    Logs.[Id], Logs.[Summary], Logs.[Description], Logs.[Origin], sv.[Name] as [LogLevel], 
                    p.FirstName + ' ' + p.LastName as [Created By], Logs.[CreatedDate]
             FROM Logs
             INNER JOIN People p ON p.ApplicationUserId = Logs.CreatedById
             INNER JOIN SystemValues sv ON sv.Id = Logs.LogLevel
             ${whereClause}
           ) AS NumberedResults
           WHERE RowNum > ${offset}
           ORDER BY RowNum`);
        
        if (result.success) {
          if (result.data && result.data.length > 0) {
            const table = createSortableTable(result.data, 'logs');
            resultsDiv.innerHTML = table;
            
            // Update pagination
            const hasMore = result.data.length === 100;
            updateLogsPagination(page, hasMore);
            
            // Load log levels chart
            await loadLogLevelsChart();
          } else {
            resultsDiv.innerHTML = '<p>No logs found.</p>';
            paginationDiv.innerHTML = '';
            clearLogLevelsChart();
          }
        } else {
          resultsDiv.innerHTML = `<div class="error">Failed to load logs: ${result.error}</div>`;
        }
      } catch (error) {
        resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
      }
    }
    
    function updateLogsPagination(currentPage, hasMore) {
      const paginationDiv = document.getElementById('logsPagination');
      let html = `Page ${currentPage} `;
      
      if (currentPage > 1) {
        html += `<button onclick="loadLogs(${currentPage - 1})">Previous</button> `;
      }
      
      if (hasMore) {
        html += `<button onclick="loadLogs(${currentPage + 1})">Next</button>`;
      }
      
      paginationDiv.innerHTML = html;
    }
    
    function clearLogsFilters() {
      setDefaultLogsDates();
      document.getElementById('logLevelFilter').selectedIndex = -1;
      loadLogs(1);
    }
    
    function sortTable(field, tableType) {
      if (tableType === 'tracking') {
        trackingSortOrder = (trackingSortField === field && trackingSortOrder === 'ASC') ? 'DESC' : 'ASC';
        trackingSortField = field;
        loadUserTracking(currentTrackingPage);
      } else if (tableType === 'logs') {
        logsSortOrder = (logsSortField === field && logsSortOrder === 'ASC') ? 'DESC' : 'ASC';
        logsSortField = field;
        loadLogs(currentLogsPage);
      }
    }
    
    function showModulesPage() {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('modulesPage').classList.add('active');
      closeAllMenus();
      loadModules();
    }
    
    function showDataDictionaryPage() {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('dataDictionaryPage').classList.add('active');
      closeAllMenus();
      loadSchemaFilter();
    }
    
    async function loadSchemaFilter() {
      try {
        const result = await ipcRenderer.invoke('execute-query', 
          `SELECT DISTINCT TABLE_SCHEMA FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE' ORDER BY TABLE_SCHEMA`);
        
        const erdSelect = document.getElementById('schemaFilter');
        const dictSelect = document.getElementById('dictionarySchemaFilter');
        
        [erdSelect, dictSelect].forEach(select => {
          select.innerHTML = '<option value="">All Schemas</option>';
          
          if (result.success && result.data) {
            result.data.forEach(row => {
              const option = document.createElement('option');
              option.value = row.TABLE_SCHEMA;
              option.textContent = row.TABLE_SCHEMA;
              select.appendChild(option);
            });
          }
        });
      } catch (error) {
        console.error('Failed to load schemas:', error);
      }
    }
    
    async function loadDataDictionary() {
      const resultsDiv = document.getElementById('dataDictionaryResults');
      resultsDiv.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="spinner"></div><p>Generating data dictionary...</p></div>';
      
      const selectedSchema = document.getElementById('dictionarySchemaFilter').value;
      let schemaFilter = '';
      if (selectedSchema) {
        schemaFilter = ` AND t.TABLE_SCHEMA = '${selectedSchema}'`;
      }
      
      try {
        const result = await ipcRenderer.invoke('execute-query', 
          `SELECT 
             t.TABLE_SCHEMA,
             t.TABLE_NAME,
             c.COLUMN_NAME,
             c.DATA_TYPE,
             c.CHARACTER_MAXIMUM_LENGTH,
             c.IS_NULLABLE,
             c.COLUMN_DEFAULT,
             CASE WHEN pk.COLUMN_NAME IS NOT NULL THEN 'YES' ELSE 'NO' END as IS_PRIMARY_KEY
           FROM INFORMATION_SCHEMA.TABLES t
           INNER JOIN INFORMATION_SCHEMA.COLUMNS c ON t.TABLE_NAME = c.TABLE_NAME AND t.TABLE_SCHEMA = c.TABLE_SCHEMA
           LEFT JOIN (
             SELECT ku.TABLE_SCHEMA, ku.TABLE_NAME, ku.COLUMN_NAME
             FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS tc
             INNER JOIN INFORMATION_SCHEMA.KEY_COLUMN_USAGE ku ON tc.CONSTRAINT_NAME = ku.CONSTRAINT_NAME
             WHERE tc.CONSTRAINT_TYPE = 'PRIMARY KEY'
           ) pk ON c.TABLE_SCHEMA = pk.TABLE_SCHEMA AND c.TABLE_NAME = pk.TABLE_NAME AND c.COLUMN_NAME = pk.COLUMN_NAME
           WHERE t.TABLE_TYPE = 'BASE TABLE'${schemaFilter}
           ORDER BY t.TABLE_SCHEMA, t.TABLE_NAME, c.ORDINAL_POSITION`);
        
        if (result.success && result.data) {
          const html = createDataDictionaryHTML(result.data);
          resultsDiv.innerHTML = html;
        } else {
          resultsDiv.innerHTML = `<div class="error">Failed to load data dictionary: ${result.error}</div>`;
        }
      } catch (error) {
        resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
      }
    }
    
    function createDataDictionaryHTML(data) {
      const tables = {};
      
      data.forEach(row => {
        const key = `${row.TABLE_SCHEMA}.${row.TABLE_NAME}`;
        if (!tables[key]) {
          tables[key] = {
            schema: row.TABLE_SCHEMA,
            name: row.TABLE_NAME,
            columns: []
          };
        }
        tables[key].columns.push(row);
      });
      
      let html = `<div style="margin-bottom: 20px;"><strong>Total Tables:</strong> ${Object.keys(tables).length}</div>`;
      
      Object.values(tables).forEach(table => {
        html += `<div style="margin-bottom: 30px; border: 1px solid #ddd; border-radius: 5px; overflow: hidden;">`;
        html += `<div style="background: #667eea; color: white; padding: 15px; font-weight: bold; font-size: 16px;">`;
        html += `${table.schema}.${table.name} (${table.columns.length} columns)</div>`;
        html += `<table style="width: 100%; margin: 0;"><thead style="background: #f8f9fa;"><tr>`;
        html += `<th>Column</th><th>Type</th><th>Length</th><th>Nullable</th><th>Default</th><th>Primary Key</th></tr></thead><tbody>`;
        
        table.columns.forEach(col => {
          const pkBadge = col.IS_PRIMARY_KEY === 'YES' ? '<span style="background: #dc3545; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px;">PK</span>' : '';
          html += `<tr>`;
          html += `<td><strong>${col.COLUMN_NAME}</strong> ${pkBadge}</td>`;
          html += `<td>${col.DATA_TYPE}</td>`;
          html += `<td>${col.CHARACTER_MAXIMUM_LENGTH || '-'}</td>`;
          html += `<td>${col.IS_NULLABLE}</td>`;
          html += `<td>${col.COLUMN_DEFAULT || '-'}</td>`;
          html += `<td>${col.IS_PRIMARY_KEY}</td>`;
          html += `</tr>`;
        });
        
        html += `</tbody></table></div>`;
      });
      
      return html;
    }
    
    function exportDataDictionary() {
      const content = document.getElementById('dataDictionaryResults').innerHTML;
      if (!content || content.includes('Click "Generate Data Dictionary"')) {
        alert('Please generate the data dictionary first');
        return;
      }
      
      const htmlContent = `<!DOCTYPE html>
<html><head><title>Database Data Dictionary</title>
<style>body{font-family:Arial,sans-serif;margin:20px;}table{border-collapse:collapse;width:100%;}th,td{border:1px solid #ddd;padding:8px;text-align:left;}th{background:#f2f2f2;}</style>
</head><body><h1>Database Data Dictionary</h1>${content}</body></html>`;
      
      const blob = new Blob([htmlContent], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'data-dictionary.html';
      a.click();
      URL.revokeObjectURL(url);
    }
    
    function showDictionaryTab(tabName) {
      document.querySelectorAll('#dataDictionaryPage .tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('#dataDictionaryPage .tab-button').forEach(btn => btn.classList.remove('active'));
      
      document.getElementById(`${tabName}Tab`).classList.add('active');
      event.target.classList.add('active');
    }
    
    let erdData = { tables: [], relationships: [] };
    
    async function loadERD() {
      const selectedSchema = document.getElementById('schemaFilter').value;
      let schemaFilter = '';
      if (selectedSchema) {
        schemaFilter = `AND s.name = '${selectedSchema}'`;
      }
      
      try {
        // Get foreign key relationships with schema filtering
        const fkResult = await ipcRenderer.invoke('execute-query', 
          `SELECT 
             fk.name AS FK_NAME,
             sp.name AS PARENT_SCHEMA,
             tp.name AS PARENT_TABLE,
             cp.name AS PARENT_COLUMN,
             sr.name AS REFERENCED_SCHEMA,
             tr.name AS REFERENCED_TABLE,
             cr.name AS REFERENCED_COLUMN
           FROM sys.foreign_keys fk
           INNER JOIN sys.foreign_key_columns fkc ON fk.object_id = fkc.constraint_object_id
           INNER JOIN sys.tables tp ON fkc.parent_object_id = tp.object_id
           INNER JOIN sys.schemas sp ON tp.schema_id = sp.schema_id
           INNER JOIN sys.columns cp ON fkc.parent_object_id = cp.object_id AND fkc.parent_column_id = cp.column_id
           INNER JOIN sys.tables tr ON fkc.referenced_object_id = tr.object_id
           INNER JOIN sys.schemas sr ON tr.schema_id = sr.schema_id
           INNER JOIN sys.columns cr ON fkc.referenced_object_id = cr.object_id AND fkc.referenced_column_id = cr.column_id
           WHERE 1=1 ${schemaFilter.replace('s.name', 'sp.name')} ${schemaFilter.replace('s.name', 'sr.name').replace('AND', 'OR')}`);
        
        // Get table info with schema filtering
        let tableWhereClause = 'WHERE t.TABLE_TYPE = \'BASE TABLE\'';
        if (selectedSchema) {
          tableWhereClause += ` AND t.TABLE_SCHEMA = '${selectedSchema}'`;
        }
        
        const tableResult = await ipcRenderer.invoke('execute-query', 
          `SELECT t.TABLE_SCHEMA, t.TABLE_NAME, 
                  c.COLUMN_NAME,
                  CASE WHEN pk.COLUMN_NAME IS NOT NULL THEN 'PK' 
                       WHEN fk.COLUMN_NAME IS NOT NULL THEN 'FK' 
                       ELSE '' END as KEY_TYPE
           FROM INFORMATION_SCHEMA.TABLES t
           INNER JOIN INFORMATION_SCHEMA.COLUMNS c ON t.TABLE_NAME = c.TABLE_NAME AND t.TABLE_SCHEMA = c.TABLE_SCHEMA
           LEFT JOIN (
             SELECT ku.TABLE_SCHEMA, ku.TABLE_NAME, ku.COLUMN_NAME
             FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS tc
             INNER JOIN INFORMATION_SCHEMA.KEY_COLUMN_USAGE ku ON tc.CONSTRAINT_NAME = ku.CONSTRAINT_NAME
             WHERE tc.CONSTRAINT_TYPE = 'PRIMARY KEY'
           ) pk ON c.TABLE_SCHEMA = pk.TABLE_SCHEMA AND c.TABLE_NAME = pk.TABLE_NAME AND c.COLUMN_NAME = pk.COLUMN_NAME
           LEFT JOIN (
             SELECT ku.TABLE_SCHEMA, ku.TABLE_NAME, ku.COLUMN_NAME
             FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS tc
             INNER JOIN INFORMATION_SCHEMA.KEY_COLUMN_USAGE ku ON tc.CONSTRAINT_NAME = ku.CONSTRAINT_NAME
             WHERE tc.CONSTRAINT_TYPE = 'FOREIGN KEY'
           ) fk ON c.TABLE_SCHEMA = fk.TABLE_SCHEMA AND c.TABLE_NAME = fk.TABLE_NAME AND c.COLUMN_NAME = fk.COLUMN_NAME
           ${tableWhereClause}
           ORDER BY t.TABLE_SCHEMA, t.TABLE_NAME, c.ORDINAL_POSITION`);
        
        if (tableResult.success && tableResult.data) {
          // Group columns by table
          const tablesMap = {};
          tableResult.data.forEach(row => {
            const key = `${row.TABLE_SCHEMA}.${row.TABLE_NAME}`;
            if (!tablesMap[key]) {
              tablesMap[key] = {
                schema: row.TABLE_SCHEMA,
                name: row.TABLE_NAME,
                fullName: key,
                columns: []
              };
            }
            tablesMap[key].columns.push({
              name: row.COLUMN_NAME,
              keyType: row.KEY_TYPE
            });
          });
          
          erdData.tables = Object.values(tablesMap).map((table, index) => ({
            ...table,
            x: 100 + (index % 5) * 220,
            y: 100 + Math.floor(index / 5) * 200
          }));
          
          erdData.relationships = fkResult.success ? fkResult.data : [];
          drawERD();
        }
      } catch (error) {
        console.error('Failed to load ERD:', error);
      }
    }
    
    function drawERD() {
      const canvas = document.getElementById('erdCanvas');
      const ctx = canvas.getContext('2d');
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Draw relationships first (behind tables)
      ctx.strokeStyle = '#666';
      ctx.lineWidth = 1;
      erdData.relationships.forEach(rel => {
        const parentTable = erdData.tables.find(t => t.fullName === `${rel.PARENT_SCHEMA}.${rel.PARENT_TABLE}`);
        const refTable = erdData.tables.find(t => t.fullName === `${rel.REFERENCED_SCHEMA}.${rel.REFERENCED_TABLE}`);
        
        if (parentTable && refTable) {
          ctx.beginPath();
          ctx.moveTo(parentTable.x + 90, parentTable.y + 15);
          ctx.lineTo(refTable.x + 90, refTable.y + 15);
          ctx.stroke();
        }
      });
      
      // Draw tables
      erdData.tables.forEach(table => {
        const maxColumns = 8; // Limit visible columns
        const visibleColumns = table.columns.slice(0, maxColumns);
        const tableHeight = 30 + (visibleColumns.length * 16) + (table.columns.length > maxColumns ? 16 : 0);
        
        // Table header
        ctx.fillStyle = '#667eea';
        ctx.fillRect(table.x, table.y, 200, 30);
        
        // Table name with schema
        ctx.fillStyle = 'white';
        ctx.font = 'bold 11px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(table.fullName, table.x + 100, table.y + 20);
        
        // Table body
        ctx.fillStyle = '#f8f9fa';
        ctx.fillRect(table.x, table.y + 30, 200, tableHeight - 30);
        
        // Draw columns
        ctx.fillStyle = '#333';
        ctx.font = '10px Arial';
        ctx.textAlign = 'left';
        
        visibleColumns.forEach((col, index) => {
          const y = table.y + 45 + (index * 16);
          
          // Column name
          ctx.fillText(col.name, table.x + 5, y);
          
          // Key type badge
          if (col.keyType) {
            const badgeColor = col.keyType === 'PK' ? '#dc3545' : '#ffc107';
            ctx.fillStyle = badgeColor;
            ctx.fillRect(table.x + 150, y - 10, 20, 12);
            ctx.fillStyle = 'white';
            ctx.font = 'bold 8px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(col.keyType, table.x + 160, y - 2);
            ctx.fillStyle = '#333';
            ctx.font = '10px Arial';
            ctx.textAlign = 'left';
          }
        });
        
        // Show "..." if more columns exist
        if (table.columns.length > maxColumns) {
          ctx.fillStyle = '#666';
          ctx.font = '10px Arial';
          ctx.textAlign = 'center';
          ctx.fillText(`... ${table.columns.length - maxColumns} more`, table.x + 100, table.y + tableHeight - 5);
        }
        
        // Store table height for drag detection
        table.height = tableHeight;
      });
    }
    
    // Add drag functionality
    let isDragging = false;
    let dragTable = null;
    let dragOffset = { x: 0, y: 0 };
    
    document.getElementById('erdCanvas').addEventListener('mousedown', (e) => {
      const rect = e.target.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      const table = erdData.tables.find(t => 
        x >= t.x && x <= t.x + 200 && y >= t.y && y <= t.y + (t.height || 50)
      );
      
      if (table) {
        isDragging = true;
        dragTable = table;
        dragOffset.x = x - table.x;
        dragOffset.y = y - table.y;
      }
    });
    
    document.getElementById('erdCanvas').addEventListener('mousemove', (e) => {
      if (isDragging && dragTable) {
        const rect = e.target.getBoundingClientRect();
        dragTable.x = e.clientX - rect.left - dragOffset.x;
        dragTable.y = e.clientY - rect.top - dragOffset.y;
        drawERD();
      }
    });
    
    document.getElementById('erdCanvas').addEventListener('mouseup', () => {
      isDragging = false;
      dragTable = null;
    });
    
    async function loadModules() {
      const resultsDiv = document.getElementById('modulesResults');
      resultsDiv.innerHTML = 'Loading modules...';
      
      try {
        const result = await ipcRenderer.invoke('execute-query', 
          `SELECT Id, Name, Label, Icon, Position
           FROM SystemModules 
           WHERE IsDeleted = 0
           ORDER BY Position`);
        
        if (result.success) {
          if (result.data && result.data.length > 0) {
            const modulesHtml = createModulesTable(result.data);
            resultsDiv.innerHTML = `<p>${result.data.length} modules found.</p>${modulesHtml}`;
          } else {
            resultsDiv.innerHTML = '<p>No modules found.</p>';
          }
        } else {
          resultsDiv.innerHTML = `<div class="error">Failed to load modules: ${result.error}</div>`;
        }
      } catch (error) {
        resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
      }
    }
    
    function createModulesTable(modules) {
      let html = '';
      
      modules.forEach(module => {
        html += `<div style="margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 5px;">`;
        html += `<h4 style="cursor: pointer; color: #667eea;" onclick="toggleModuleFunctions('${module.Id}')">`;
        html += `‚ñ∂ ${module.Label} (${module.Name}) - Position: ${module.Position}</h4>`;
        html += `<div id="functions_${module.Id}" style="display: none; margin-top: 10px;">Loading functions...</div>`;
        html += `</div>`;
      });
      
      return html;
    }
    
    async function toggleModuleFunctions(moduleId) {
      const functionsDiv = document.getElementById(`functions_${moduleId}`);
      const header = event.target;
      
      if (functionsDiv.style.display === 'none') {
        functionsDiv.style.display = 'block';
        header.innerHTML = header.innerHTML.replace('‚ñ∂', '‚ñº');
        
        try {
          const result = await ipcRenderer.invoke('execute-query', 
            `SELECT Id, Name, Label, IconName, Route, 
                    CASE WHEN IsMenu = 1 THEN 'Yes' ELSE 'No' END as IsMenu,
                    Position
             FROM SystemFunctions 
             WHERE SystemModuleId = '${moduleId}' AND IsDeleted = 0
             ORDER BY Position`);
          
          if (result.success && result.data && result.data.length > 0) {
            const functionsHtml = await createFunctionsTable(result.data);
            functionsDiv.innerHTML = `<p>${result.data.length} functions found:</p>${functionsHtml}`;
          } else {
            functionsDiv.innerHTML = '<p>No functions found for this module.</p>';
          }
        } catch (error) {
          functionsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
        }
      } else {
        functionsDiv.style.display = 'none';
        header.innerHTML = header.innerHTML.replace('‚ñº', '‚ñ∂');
      }
    }
    
    async function createFunctionsTable(functions) {
      let html = '<table><thead><tr><th>Name</th><th>Label</th><th>IconName</th><th>Route</th><th>IsMenu</th><th>Position</th><th>Roles</th></tr></thead><tbody>';
      
      for (const func of functions) {
        // Get roles for this function
        let roles = 'N/A';
        try {
          const rolesResult = await ipcRenderer.invoke('execute-query', 
            `select asr.Name from SystemFunctions sf
             inner join SystemFunctionRoles sfr
               on sfr.SystemFunctionId = sf.Id
             inner join [TrustJanusPlatform].dbo.aspnetroles asr
               on asr.id = sfr.roleId
             where sf.id = '${func.Id}'`);
          
          if (rolesResult.success && rolesResult.data && rolesResult.data.length > 0) {
            roles = rolesResult.data.map(r => r.Name).join(', ');
          } else {
            roles = 'No roles assigned';
          }
        } catch (error) {
          roles = 'N/A';
        }
        
        html += '<tr>';
        html += `<td>${func.Name || 'NULL'}</td>`;
        html += `<td>${func.Label || 'NULL'}</td>`;
        html += `<td>${func.IconName || 'NULL'}</td>`;
        html += `<td>${func.Route || 'NULL'}</td>`;
        html += `<td>${func.IsMenu || 'NULL'}</td>`;
        html += `<td>${func.Position || 'NULL'}</td>`;
        html += `<td>${roles}</td>`;
        html += '</tr>';
      }
      
      html += '</tbody></table>';
      return html;
    }
    
    function showRolesPage() {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('rolesPage').classList.add('active');
      closeAllMenus();
      loadRolesFilterOptions();
      loadRoles(1);
    }
    
    async function loadRolesFilterOptions() {
      // Disable roles page functionality since System_Roles_Workflows_View doesn't exist
      document.getElementById('rolesTenantFilter').innerHTML = '<option>View not available</option>';
      document.getElementById('rolesRoleFilter').innerHTML = '<option>View not available</option>';
      document.getElementById('rolesModuleFilter').innerHTML = '<option>View not available</option>';
      document.getElementById('rolesFunctionFilter').innerHTML = '<option>View not available</option>';
      document.getElementById('rolesWorkflowFilter').innerHTML = '<option>View not available</option>';
      document.getElementById('rolesLastNameFilter').innerHTML = '<option>View not available</option>';
    }
    
    let currentRolesPage = 1;
    let rolesSortField = 'Tenant';
    let rolesSortOrder = 'ASC';
    
    async function loadRoles(page = 1) {
      currentRolesPage = page;
      const resultsDiv = document.getElementById('rolesResults');
      const paginationDiv = document.getElementById('rolesPagination');
      
      const tenantFilter = getSelectedValues('rolesTenantFilter');
      const roleFilter = getSelectedValues('rolesRoleFilter');
      const moduleFilter = getSelectedValues('rolesModuleFilter');
      const functionFilter = getSelectedValues('rolesFunctionFilter');
      const workflowFilter = getSelectedValues('rolesWorkflowFilter');
      const lastNameFilter = getSelectedValues('rolesLastNameFilter');
      
      let whereClause = 'WHERE 1=1';
      if (tenantFilter.length > 0) {
        const tenantList = tenantFilter.map(t => `'${t}'`).join(',');
        whereClause += ` AND Tenant IN (${tenantList})`;
      }
      if (roleFilter.length > 0) {
        const roleList = roleFilter.map(r => `'${r}'`).join(',');
        whereClause += ` AND Role IN (${roleList})`;
      }
      if (moduleFilter.length > 0) {
        const moduleList = moduleFilter.map(m => `'${m}'`).join(',');
        whereClause += ` AND Module IN (${moduleList})`;
      }
      if (functionFilter.length > 0) {
        const functionList = functionFilter.map(f => `'${f}'`).join(',');
        whereClause += ` AND [Function] IN (${functionList})`;
      }
      if (workflowFilter.length > 0) {
        const workflowList = workflowFilter.map(w => `'${w}'`).join(',');
        whereClause += ` AND Workflow IN (${workflowList})`;
      }
      if (lastNameFilter.length > 0) {
        const lastNameList = lastNameFilter.map(l => `'${l}'`).join(',');
        whereClause += ` AND LastName IN (${lastNameList})`;
      }
      
      const offset = (page - 1) * 100;
      
      resultsDiv.innerHTML = 'Loading roles...';
      
      try {
        // System_Roles_Workflows_View doesn't exist, show message instead
        const result = { success: true, data: [] };
        
        resultsDiv.innerHTML = '<div class="error">System_Roles_Workflows_View does not exist in the database. This view needs to be created to display roles data.</div>';
        paginationDiv.innerHTML = '';
      } catch (error) {
        resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
      }
    }
    
    function updateRolesPagination(currentPage, hasMore) {
      const paginationDiv = document.getElementById('rolesPagination');
      let html = `Page ${currentPage} `;
      
      if (currentPage > 1) {
        html += `<button onclick="loadRoles(${currentPage - 1})">Previous</button> `;
      }
      
      if (hasMore) {
        html += `<button onclick="loadRoles(${currentPage + 1})">Next</button>`;
      }
      
      paginationDiv.innerHTML = html;
    }
    
    function clearRolesFilters() {
      document.getElementById('rolesTenantFilter').selectedIndex = -1;
      document.getElementById('rolesRoleFilter').selectedIndex = -1;
      document.getElementById('rolesModuleFilter').selectedIndex = -1;
      document.getElementById('rolesFunctionFilter').selectedIndex = -1;
      document.getElementById('rolesWorkflowFilter').selectedIndex = -1;
      document.getElementById('rolesLastNameFilter').selectedIndex = -1;
      loadRoles(1);
    }
    
    function openWorkflowFromRoles(workflowId, workflowName) {
      currentWorkflowId = workflowId;
      // Switch to workflows page and open the specific workflow
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('workflowOpenPage').classList.add('active');
      document.getElementById('workflowTitle').textContent = `Workflow: ${workflowName} (${workflowId})`;
      
      // Reset to details tab
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.getElementById('workflowDetailsTab').classList.add('active');
      document.querySelector('.tab-button').classList.add('active');
      
      loadWorkflowDetails(workflowId);
      loadWorkflowActivities(workflowId);
      loadTasksCount(workflowId);
    }
    
    function sortTable(field, tableType) {
      if (tableType === 'tracking') {
        trackingSortOrder = (trackingSortField === field && trackingSortOrder === 'ASC') ? 'DESC' : 'ASC';
        trackingSortField = field;
        loadUserTracking(currentTrackingPage);
      } else if (tableType === 'logs') {
        logsSortOrder = (logsSortField === field && logsSortOrder === 'ASC') ? 'DESC' : 'ASC';
        logsSortField = field;
        loadLogs(currentLogsPage);
      } else if (tableType === 'roles') {
        rolesSortOrder = (rolesSortField === field && rolesSortOrder === 'ASC') ? 'DESC' : 'ASC';
        rolesSortField = field;
        loadRoles(currentRolesPage);
      } else if (tableType === 'workflowTasks') {
        workflowTasksSortOrder = (workflowTasksSortField === field && workflowTasksSortOrder === 'ASC') ? 'DESC' : 'ASC';
        workflowTasksSortField = field;
        loadWorkflowTasks(currentWorkflowId, currentWorkflowTasksPage);
      }
    }
    
    let currentWorkflowTasksPage = 1;
    let workflowTasksSortField = 'e.CreatedDate';
    let workflowTasksSortOrder = 'DESC';
    let currentWorkflowId = null;
    
    async function loadWorkflowTasks(workflowId, page = 1) {
      currentWorkflowTasksPage = page;
      currentWorkflowId = workflowId;
      const tasksDiv = document.getElementById('workflowTasks');
      const paginationDiv = document.getElementById('workflowTasksPagination');
      
      // Load activities for filter dropdown
      await loadActivitiesFilter(workflowId);
      
      const offset = (page - 1) * 100;
      
      // Build filter conditions
      const fromDate = document.getElementById('tasksFromDate')?.value;
      const thruDate = document.getElementById('tasksThruDate')?.value;
      const activity = document.getElementById('activityFilter')?.value;
      const notesCount = document.getElementById('notesCountFilter')?.value;
      const customerReplies = document.getElementById('customerRepliesFilter')?.value;
      const sentiment = document.getElementById('sentimentFilter')?.value;
      const subject = document.getElementById('subjectFilter')?.value;
      const subjectContains = document.getElementById('subjectContains')?.checked;
      
      let whereClause = `WHERE w.id = ${workflowId}`;
      if (fromDate) {
        whereClause += ` AND e.UpdatedDate >= '${fromDate}'`;
      }
      if (thruDate) {
        whereClause += ` AND e.UpdatedDate <= '${thruDate} 23:59:59'`;
      }
      if (activity) {
        whereClause += ` AND wa.Name = '${activity}'`;
      }
      if (sentiment) {
        whereClause += ` AND wt.Sentiment = '${sentiment}'`;
      }
      if (subject) {
        const escapedSubject = subject.replace(/'/g, "''");
        if (subjectContains) {
          whereClause += ` AND e.Subject LIKE '%${escapedSubject}%'`;
        } else {
          whereClause += ` AND e.Subject = '${escapedSubject}'`;
        }
      }
      
      let havingClause = '';
      const havingConditions = [];
      if (notesCount) {
        havingConditions.push(`count(wtn.WorkflowTaskId) > ${notesCount}`);
      }
      if (customerReplies) {
        havingConditions.push(`count(children.Id) > ${customerReplies}`);
      }
      if (havingConditions.length > 0) {
        havingClause = ` HAVING ${havingConditions.join(' AND ')}`;
      }
      
      try {
        const result = await ipcRenderer.invoke('execute-query', 
          `SELECT wa.Name as Activity, wa.ServiceLevelAgreementTicks, sv.Name as ActivityType,
                  wt.Sentiment, wt.SlaCalculationDate, wt.SlaSeconds, wt.Id as WorkflowTaskId,
                  e.Subject, e.[From], 
                  CASE WHEN e.IsHighImportance = 1 THEN 'Yes' ELSE 'No' END as IsHighImportance,
                  e.CreatedDate, e.UpdatedDate, count(wtn.WorkflowTaskId) as [Internal Replies], 
                  count(children.Id) as [Customer Replies], e.Id
           FROM workflows w
           INNER JOIN WorkflowActivities wa ON wa.WorkflowId = w.Id
           INNER JOIN WorkflowTasks wt ON wt.WorkflowActivityId = wa.Id AND wt.IsDeleted = 0
           INNER JOIN Emails e ON e.Id = wt.ParentId AND e.TenantId = wt.TenantId AND e.IsDeleted = 0
           INNER JOIN SystemValues sv ON sv.id = wa.ActivityTypeValueId
           LEFT OUTER JOIN WorkflowTaskNotes wtn ON wtn.WorkflowTaskId = wt.Id
           LEFT OUTER JOIN Emails children ON children.ParentId = e.Id
           ${whereClause}
           GROUP BY wa.Name, wa.ServiceLevelAgreementTicks, sv.Name, wt.Sentiment, 
                    wt.SlaCalculationDate, wt.SlaSeconds, wt.Id, e.Subject, e.[From], 
                    e.IsHighImportance, e.CreatedDate, e.UpdatedDate, e.Id
           ${havingClause}
           ORDER BY ${workflowTasksSortField} ${workflowTasksSortOrder}
           OFFSET ${offset} ROWS FETCH NEXT 100 ROWS ONLY`);
        
        if (result.success) {
          if (result.data && result.data.length > 0) {
            const table = createSortableTable(result.data, 'workflowTasks');
            tasksDiv.innerHTML = table;
            
            // Update pagination
            const hasMore = result.data.length === 100;
            updateWorkflowTasksPagination(page, hasMore, workflowId);
          } else {
            tasksDiv.innerHTML = '<p>No tasks found for this workflow.</p>';
            paginationDiv.innerHTML = '';
          }
        } else {
          tasksDiv.innerHTML = `<div class="error">Failed to load tasks: ${result.error}</div>`;
        }
      } catch (error) {
        tasksDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
      }
    }
    
    async function loadActivitiesFilter(workflowId) {
      try {
        const result = await ipcRenderer.invoke('execute-query', 
          `SELECT DISTINCT wa.Name
           FROM WorkflowActivities wa
           WHERE wa.WorkflowId = ${workflowId} AND wa.IsDeleted = 0
           ORDER BY wa.Name`);
        
        const select = document.getElementById('activityFilter');
        if (select && result.success && result.data) {
          select.innerHTML = '<option value="">All Activities</option>';
          result.data.forEach(item => {
            const option = document.createElement('option');
            option.value = item.Name;
            option.textContent = item.Name;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Failed to load activities filter:', error);
      }
    }
    
    function clearTasksFilters() {
      document.getElementById('tasksFromDate').value = '';
      document.getElementById('tasksThruDate').value = '';
      document.getElementById('activityFilter').value = '';
      document.getElementById('notesCountFilter').value = '';
      document.getElementById('customerRepliesFilter').value = '';
      document.getElementById('sentimentFilter').value = '';
      document.getElementById('subjectFilter').value = '';
      document.getElementById('subjectContains').checked = false;
      loadWorkflowTasks(currentWorkflowId, 1);
    }
    
    function updateWorkflowTasksPagination(currentPage, hasMore, workflowId) {
      const paginationDiv = document.getElementById('workflowTasksPagination');
      let html = `Page ${currentPage} `;
      
      if (currentPage > 1) {
        html += `<button onclick="loadWorkflowTasks(${workflowId}, ${currentPage - 1})">Previous</button> `;
      }
      
      if (hasMore) {
        html += `<button onclick="loadWorkflowTasks(${workflowId}, ${currentPage + 1})">Next</button>`;
      }
      
      paginationDiv.innerHTML = html;
    }
    
    function showWorkflowTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      
      // Show selected tab
      document.getElementById(`workflow${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Tab`).classList.add('active');
      event.target.classList.add('active');
      
      // Load tasks only when tasks tab is clicked
      if (tabName === 'tasks') {
        const workflowId = currentWorkflowId;
        if (workflowId) {
          document.getElementById('workflowTasks').innerHTML = 'Loading tasks...';
          loadWorkflowTasks(workflowId, 1);
        } else {
          document.getElementById('workflowTasks').innerHTML = 'No workflow selected';
        }
      }
      
      // Load performance charts when performance tab is clicked
      if (tabName === 'performance') {
        setDefaultPerformanceDates();
        loadPerformanceCharts();
      }
    }
    
    async function loadTasksCount(workflowId) {
      try {
        const result = await ipcRenderer.invoke('execute-query', 
          `SELECT COUNT(*) as TaskCount
           FROM workflows w
           INNER JOIN WorkflowActivities wa ON wa.WorkflowId = w.Id
           INNER JOIN WorkflowTasks wt ON wt.WorkflowActivityId = wa.Id AND wt.IsDeleted = 0
           INNER JOIN Emails e ON e.Id = wt.ParentId AND e.TenantId = wt.TenantId AND e.IsDeleted = 0
           WHERE w.id = ${workflowId}`);
        
        if (result.success && result.data && result.data.length > 0) {
          const count = result.data[0].TaskCount;
          document.getElementById('tasksTabBtn').textContent = `Tasks (${count})`;
        }
      } catch (error) {
        console.error('Failed to load task count:', error);
      }
    }
    
    function createWorkflowDetailsGrid(data) {
      const fields = [
        { key: 'Id', label: 'Workflow ID' },
        { key: 'TenantId', label: 'Tenant ID' },
        { key: 'Name', label: 'Name' },
        { key: 'EmailSignature', label: 'Email Signature' },
        { key: 'EmailUserName', label: 'Email Username' },
        { key: 'EmailMailboxOwner', label: 'Email Mailbox Owner' },
        { key: 'SyncEnabled', label: 'Sync Enabled' },
        { key: 'IsRouter', label: 'Is Router' },
        { key: 'IsRoutable', label: 'Is Routable' },
        { key: 'IsReRouteAllowed', label: 'Re-Route Allowed' },
        { key: 'CreatedById', label: 'Created By' },
        { key: 'CreatedDate', label: 'Created Date' },
        { key: 'UpdatedById', label: 'Updated By' },
        { key: 'UpdatedDate', label: 'Updated Date' }
      ];
      
      let html = '<div class="workflow-details-grid">';
      
      fields.forEach(field => {
        const value = data[field.key] !== null ? data[field.key] : 'NULL';
        html += `
          <div class="detail-item">
            <div class="detail-label">${field.label}</div>
            <div class="detail-value">${value}</div>
          </div>`;
      });
      
      html += '</div>';
      return html;
    }
    
    async function loadPerformanceCharts() {
      if (!currentWorkflowId) return;
      
      const fromDate = document.getElementById('performanceFromDate').value;
      const toDate = document.getElementById('performanceToDate').value;
      const dateFilter = getDateRangeFilter(fromDate, toDate, 'wt');
      const emailDateFilter = getDateRangeFilter(fromDate, toDate, 'n');
      
      try {
        // Show loading animations
        document.getElementById('notesLoading').style.display = 'flex';
        document.getElementById('timeToReplyLoading').style.display = 'flex';
        document.getElementById('mailActionsLoading').style.display = 'flex';
        
        // Load notes per day
        const notesResult = await ipcRenderer.invoke('execute-query', 
          `SELECT CAST(wt.CreatedDate AS DATE) as NoteDate, COUNT(*) as NoteCount
           FROM workflows w WITH (NOLOCK)
           INNER JOIN WorkflowActivities wa WITH (NOLOCK) ON wa.WorkflowId = w.Id
           INNER JOIN WorkflowTasks wt WITH (NOLOCK) ON wt.WorkflowActivityId = wa.Id AND wt.IsDeleted = 0
           INNER JOIN Emails e WITH (NOLOCK) 
           	ON e.Id = wt.ParentId AND e.TenantId = wt.TenantId AND e.IsDeleted = 0
           LEFT OUTER JOIN WorkflowTaskNotes wtn WITH (NOLOCK) ON wtn.WorkflowTaskId = wt.Id
           LEFT JOIN Notes n WITH (NOLOCK) ON n.id = wtn.NoteId AND n.IsDeleted = 0
           LEFT OUTER JOIN Emails replies
             on replies.ParentId = e.Id
           WHERE w.id = ${currentWorkflowId} AND wt.CreatedDate IS NOT NULL ${dateFilter}
           GROUP BY CAST(wt.CreatedDate AS DATE)
           ORDER BY NoteDate`);
        
        if (notesResult.success && notesResult.data) {
          console.log('Raw notes data:', notesResult.data);
          const completeNotesData = fillMissingDates(notesResult.data, fromDate, toDate, 'NoteDate', 'NoteCount');
          console.log('Complete notes data after fillMissingDates:', completeNotesData);
          completeNotesData.sort((a, b) => new Date(a.NoteDate) - new Date(b.NoteDate));
          drawNotesPerDayChart(completeNotesData);
        }
        document.getElementById('notesLoading').style.display = 'none';
        
        // Load mail actions
        const actionsResult = await ipcRenderer.invoke('execute-query', 
          `SELECT sv2.Name as MailAction, COUNT(*) as ActionCount
           FROM workflows w WITH (NOLOCK)
           INNER JOIN WorkflowActivities wa WITH (NOLOCK) ON wa.WorkflowId = w.Id
           INNER JOIN WorkflowTasks wt WITH (NOLOCK) ON wt.WorkflowActivityId = wa.Id AND wt.IsDeleted = 0
           INNER JOIN Emails e WITH (NOLOCK) ON e.Id = wt.ParentId AND e.TenantId = wt.TenantId AND e.IsDeleted = 0
           INNER JOIN WorkflowTaskNotes wtn WITH (NOLOCK) ON wtn.WorkflowTaskId = wt.Id
           INNER JOIN Notes n WITH (NOLOCK) ON n.id = wtn.NoteId AND n.IsDeleted = 0
           INNER JOIN SystemValues sv2 WITH (NOLOCK) ON sv2.id = n.MailActionTypeValueId
           WHERE w.id = ${currentWorkflowId} AND sv2.Name IS NOT NULL ${dateFilter}
           GROUP BY sv2.Name
           ORDER BY ActionCount DESC`);
        
        if (actionsResult.success && actionsResult.data) {
          drawMailActionsChart(actionsResult.data);
        }
        document.getElementById('mailActionsLoading').style.display = 'none';
        
        // Load time to reply per day
        const timeToReplyResult = await ipcRenderer.invoke('execute-query', 
          `SELECT CAST(n.CreatedDate AS DATE) as ReplyDate, 
                  AVG(DATEDIFF(MINUTE, e.CreatedDate, n.CreatedDate)) as AvgTimeToReplyHours
           FROM workflows w WITH (NOLOCK)
           INNER JOIN WorkflowActivities wa WITH (NOLOCK) ON wa.WorkflowId = w.Id
           INNER JOIN WorkflowTasks wt WITH (NOLOCK) ON wt.WorkflowActivityId = wa.Id AND wt.IsDeleted = 0
           INNER JOIN Emails e WITH (NOLOCK) ON e.Id = wt.ParentId AND e.TenantId = wt.TenantId AND e.IsDeleted = 0
           INNER JOIN WorkflowTaskNotes wtn WITH (NOLOCK) ON wtn.WorkflowTaskId = wt.Id
           INNER JOIN Notes n WITH (NOLOCK) ON n.id = wtn.NoteId AND n.IsDeleted = 0
           WHERE w.id = ${currentWorkflowId} 
           AND n.CreatedDate IS NOT NULL AND e.CreatedDate IS NOT NULL ${emailDateFilter}
           GROUP BY CAST(n.CreatedDate AS DATE)
           ORDER BY ReplyDate`);
        
        if (timeToReplyResult.success && timeToReplyResult.data) {
          console.log('Raw timeToReply data:', timeToReplyResult.data);
          console.log('Date range:', fromDate, 'to', toDate);
          const completeReplyData = fillMissingDates(timeToReplyResult.data, fromDate, toDate, 'ReplyDate', 'AvgTimeToReplyHours');
          console.log('Complete timeToReply data after fillMissingDates:', completeReplyData);
          completeReplyData.sort((a, b) => new Date(a.ReplyDate) - new Date(b.ReplyDate));
          drawTimeToReplyChart(completeReplyData);
        }
        document.getElementById('timeToReplyLoading').style.display = 'none';
        
      } catch (error) {
        console.error('Failed to load performance charts:', error);
      }
    }
    
    function getDateRangeFilter(fromDate, toDate, tableAlias) {
      if (!fromDate || !toDate) return '';
      return ` AND ${tableAlias}.CreatedDate >= '${fromDate}' AND ${tableAlias}.CreatedDate <= '${toDate} 23:59:59'`;
    }
    
    function setDefaultPerformanceDates() {
      const now = new Date();
      const firstOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
      const today = new Date();
      
      document.getElementById('performanceFromDate').value = firstOfMonth.toISOString().split('T')[0];
      document.getElementById('performanceToDate').value = today.toISOString().split('T')[0];
    }
    
    function fillMissingDates(data, fromDate, toDate, dateField, countField) {
      if (!fromDate || !toDate) return data || [];
      
      const result = [];
      const start = new Date(fromDate + 'T00:00:00');
      const end = new Date(toDate + 'T00:00:00');
      
      for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
        const dateStr = d.toISOString().split('T')[0];
        const existing = data && data.find(item => {
          const itemDate = new Date(item[dateField]).toISOString().split('T')[0];
          return itemDate === dateStr;
        });
        
        if (existing) {
          // Ensure consistent date format as string
          const normalizedItem = { ...existing };
          normalizedItem[dateField] = dateStr;
          result.push(normalizedItem);
        } else {
          const emptyItem = {};
          emptyItem[dateField] = dateStr;
          emptyItem[countField] = 0;
          result.push(emptyItem);
        }
      }
      
      return result;
    }
    
    function drawNotesPerDayChart(data) {
      const canvas = document.getElementById('notesPerDayChart');
      const ctx = canvas.getContext('2d');
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      if (!data || data.length === 0 || data.every(item => item.NoteCount === 0)) {
        ctx.fillStyle = 'black';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('No data found', canvas.width / 2, canvas.height / 2);
        return;
      }
      
      const maxCount = Math.max(...data.map(item => item.NoteCount));
      const barWidth = Math.max(15, (canvas.width - 200) / data.length);
      const maxBarHeight = canvas.height - 180;
      
      const colors = ['#36A2EB', '#4BC0C0', '#FFCE56', '#FF6384', '#9966FF'];
      
      data.forEach((item, index) => {
        const barHeight = (item.NoteCount / maxCount) * maxBarHeight;
        const x = 100 + index * barWidth;
        const y = canvas.height - 160 - barHeight;
        
        ctx.fillStyle = colors[index % colors.length];
        ctx.fillRect(x, y, barWidth - 5, barHeight);
        
        ctx.fillStyle = 'black';
        ctx.font = '10px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(item.NoteCount, x + barWidth/2, y - 5);
        
        const date = new Date(item.NoteDate).toLocaleDateString();
        ctx.save();
        ctx.translate(x + barWidth/2, canvas.height - 80);
        ctx.rotate(-Math.PI/4);
        ctx.textAlign = 'right';
        ctx.fillStyle = 'black';
        ctx.font = 'bold 12px Arial';
        ctx.fillText(date, 0, 0);
        ctx.restore();
      });
    }
    
    function drawMailActionsChart(data) {
      const canvas = document.getElementById('mailActionsChart');
      const ctx = canvas.getContext('2d');
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      if (!data || data.length === 0) {
        ctx.fillStyle = 'black';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('No data found', canvas.width / 2, canvas.height / 2);
        return;
      }
      
      const total = data.reduce((sum, item) => sum + item.ActionCount, 0);
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const radius = Math.min(centerX, centerY) - 40;
      
      let currentAngle = 0;
      const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
      
      data.forEach((item, index) => {
        const sliceAngle = (item.ActionCount / total) * 2 * Math.PI;
        
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
        ctx.closePath();
        ctx.fillStyle = colors[index % colors.length];
        ctx.fill();
        
        const labelAngle = currentAngle + sliceAngle / 2;
        const labelX = centerX + Math.cos(labelAngle) * (radius * 0.7);
        const labelY = centerY + Math.sin(labelAngle) * (radius * 0.7);
        
        ctx.fillStyle = 'white';
        ctx.font = '10px Arial';
        ctx.textAlign = 'center';
        const label = item.MailAction || 'Unknown';
        ctx.fillText(label.length > 8 ? label.substring(0, 8) + '...' : label, labelX, labelY);
        ctx.fillText(item.ActionCount, labelX, labelY + 12);
        
        currentAngle += sliceAngle;
      });
    }
    
    async function openWorkflowTask(workflowTaskId) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('workflowTaskOpenPage').classList.add('active');
      document.getElementById('workflowTaskTitle').textContent = `Workflow Task Details (ID: ${workflowTaskId})`;
      
      await loadWorkflowTaskDetails(workflowTaskId);
      await loadWorkflowTaskReplies(workflowTaskId);
    }
    
    async function loadWorkflowTaskDetails(workflowTaskId) {
      const detailsDiv = document.getElementById('workflowTaskDetails');
      detailsDiv.innerHTML = 'Loading task details...';
      
      try {
        const result = await ipcRenderer.invoke('execute-query', 
          `select wt.Name as TaskName, wa.Name as ActivityName, e.Subject, e.[From], e.[To], e.CreatedDate, e.Body
           from WorkflowTasks wt
           inner join WorkflowActivities wa
             on wa.Id = wt.WorkflowActivityId
           left outer join Emails e
             on e.Id = wt.ParentId
           where wt.id = ${workflowTaskId}`);
        
        if (result.success && result.data && result.data.length > 0) {
          const task = result.data[0];
          let html = '<div style="background: white; padding: 20px; border-radius: 5px;">';
          html += `<p><strong>Task Name:</strong> ${task.TaskName || 'N/A'}</p>`;
          html += `<p><strong>Activity Name:</strong> ${task.ActivityName || 'N/A'}</p>`;
          html += `<p><strong>Subject:</strong> ${task.Subject || 'N/A'}</p>`;
          html += `<p><strong>From:</strong> ${task.From || 'N/A'}</p>`;
          html += `<p><strong>To:</strong> ${task.To || 'N/A'}</p>`;
          html += `<p><strong>Created Date:</strong> ${task.CreatedDate || 'N/A'}</p>`;
          html += `<p><strong>Body:</strong> <span onclick="toggleTaskBody()" style="cursor: pointer; color: #667eea;">‚ñ∂ Show</span></p>`;
          html += `<div id="taskBodyContent" style="display: none; border: 1px solid #ddd; padding: 15px; background: white; margin-top: 10px; max-height: 400px; overflow-y: auto;">${task.Body || 'No content'}</div>`;
          html += `<p style="margin-top: 15px;"><button id="aiAnalysisBtn" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">ü§ñ AI Analysis</button></p>`;
          html += '</div>';
          
          // Store body content and add click handler after DOM update
          setTimeout(() => {
            const btn = document.getElementById('aiAnalysisBtn');
            if (btn) {
              btn.onclick = () => analyzeWithAI(task.Body || '');
            }
          }, 100);
          detailsDiv.innerHTML = html;
        } else {
          detailsDiv.innerHTML = '<div class="error">Task not found</div>';
        }
      } catch (error) {
        detailsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
      }
    }
    
    async function loadWorkflowTaskReplies(workflowTaskId) {
      const repliesDiv = document.getElementById('workflowTaskReplies');
      repliesDiv.innerHTML = 'Loading replies...';
      
      try {
        // Load customer replies (child emails)
        const customerResult = await ipcRenderer.invoke('execute-query', 
          `select child.Id, child.Subject, child.[From], child.CreatedDate, 'Customer Reply' as ReplyType
           from WorkflowTasks wt
           inner join WorkflowActivities wa
             on wa.Id = wt.WorkflowActivityId
           inner join Emails e
             on e.ID = wt.ParentId
           inner join Emails child
             on child.ParentId = e.Id
           where wt.id = ${workflowTaskId}`);
        
        // Load internal replies (notes)
        const internalResult = await ipcRenderer.invoke('execute-query', 
          `select n.Id, n.Subject, '' as [From], n.CreatedDate, 'Internal Reply' as ReplyType
           from WorkflowTasks wt
           inner join WorkflowActivities wa
             on wa.Id = wt.WorkflowActivityId
           inner join WorkflowTaskNotes wtn
             on wtn.WorkflowTaskId = wt.Id
           inner join Notes n
             on n.id = wtn.NoteId
           where wt.id = ${workflowTaskId}`);
        
        // Combine and sort by CreatedDate
        let allReplies = [];
        if (customerResult.success && customerResult.data) {
          allReplies = allReplies.concat(customerResult.data);
        }
        if (internalResult.success && internalResult.data) {
          allReplies = allReplies.concat(internalResult.data);
        }
        
        // Sort chronologically
        allReplies.sort((a, b) => new Date(a.CreatedDate) - new Date(b.CreatedDate));
        
        if (allReplies.length > 0) {
          let html = '';
          allReplies.forEach((reply, index) => {
            const borderColor = reply.ReplyType === 'Customer Reply' ? '#667eea' : '#28a745';
            const marginLeft = reply.ReplyType === 'Customer Reply' ? 'margin-left: 30px; ' : '';
            html += `<div style="background: white; padding: 15px; border-radius: 5px; margin-bottom: 15px; border-left: 4px solid ${borderColor}; ${marginLeft}">`;
            const icon = reply.ReplyType === 'Customer Reply' ? 'üë§' : 'üè¢';
            html += `<h5>${icon} ${reply.ReplyType}</h5>`;
            if (reply.From) {
              html += `<p><strong>From:</strong> ${reply.From}</p>`;
            }
            html += `<p><strong>Subject:</strong> ${reply.Subject || 'N/A'}</p>`;
            html += `<p><strong>Created Date:</strong> ${reply.CreatedDate || 'N/A'}</p>`;
            if (reply.ReplyType === 'Internal Reply' && reply.Id) {
              html += `<p><span class="body-icon" onclick="showNoteModal(${reply.Id})" title="View Note Details">üìÑ View Details</span></p>`;
            } else if (reply.ReplyType === 'Customer Reply' && reply.Id) {
              html += `<p><span class="body-icon" onclick="showEmailModal(${reply.Id})" title="View Email Details">üìÑ View Details</span></p>`;
            }
            html += '</div>';
          });
          repliesDiv.innerHTML = html;
        } else {
          repliesDiv.innerHTML = '<p>No replies found for this task.</p>';
        }
      } catch (error) {
        repliesDiv.innerHTML = `<div class="error">Error loading replies: ${error.message}</div>`;
      }
    }
    

    
    function showBodyModal(title, body) {
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalBody').textContent = body || 'No content available';
      document.getElementById('bodyModal').style.display = 'block';
    }
    
    function closeBodyModal() {
      document.getElementById('bodyModal').style.display = 'none';
    }
    
    async function showNoteModal(noteId) {
      try {
        const result = await ipcRenderer.invoke('execute-query', 
          `select n.Subject, n.Body, n.CreatedDate, n.Id
           from WorkflowTasks wt
           inner join WorkflowActivities wa
             on wa.Id = wt.WorkflowActivityId
           inner join WorkflowTaskNotes wtn
             on wtn.WorkflowTaskId = wt.Id
           inner join Notes n
             on n.id = wtn.NoteId
           where n.id = ${noteId}`);
        
        if (result.success && result.data && result.data.length > 0) {
          const note = result.data[0];
          let content = `<p><strong>Note ID:</strong> ${note.Id}</p>`;
          content += `<p><strong>Subject:</strong> ${note.Subject || 'N/A'}</p>`;
          content += `<p><strong>Created Date:</strong> ${note.CreatedDate || 'N/A'}</p>`;
          content += `<p><strong>Body:</strong></p>`;
          content += `<div style="border: 1px solid #ddd; padding: 15px; background: white; margin-top: 10px; max-height: 400px; overflow-y: auto;">${note.Body || 'No content'}</div>`;
          
          document.getElementById('modalTitle').textContent = 'üè¢ Internal Reply Details';
          document.getElementById('modalBody').innerHTML = content;
          document.getElementById('bodyModal').style.display = 'block';
        } else {
          alert('Note not found');
        }
      } catch (error) {
        alert(`Error loading note: ${error.message}`);
      }
    }
    
    async function showEmailModal(emailId) {
      try {
        const result = await ipcRenderer.invoke('execute-query', 
          `select e.Subject, e.Body, e.CreatedDate, e.Id, e.[From]
           from Emails e
           where e.id = ${emailId}`);
        
        if (result.success && result.data && result.data.length > 0) {
          const email = result.data[0];
          let content = `<p><strong>Email ID:</strong> ${email.Id}</p>`;
          content += `<p><strong>Subject:</strong> ${email.Subject || 'N/A'}</p>`;
          content += `<p><strong>From:</strong> ${email.From || 'N/A'}</p>`;
          content += `<p><strong>Created Date:</strong> ${email.CreatedDate || 'N/A'}</p>`;
          content += `<p><strong>Body:</strong></p>`;
          content += `<div style="border: 1px solid #ddd; padding: 15px; background: white; margin-top: 10px; max-height: 400px; overflow-y: auto;">${email.Body || 'No content'}</div>`;
          
          document.getElementById('modalTitle').textContent = 'üë§ Customer Reply Details';
          document.getElementById('modalBody').innerHTML = content;
          document.getElementById('bodyModal').style.display = 'block';
        } else {
          alert('Email not found');
        }
      } catch (error) {
        alert(`Error loading email: ${error.message}`);
      }
    }
    
    function toggleTaskBody() {
      const content = document.getElementById('taskBodyContent');
      const toggle = event.target;
      
      if (content.style.display === 'none') {
        content.style.display = 'block';
        toggle.innerHTML = '‚ñº Hide';
      } else {
        content.style.display = 'none';
        toggle.innerHTML = '‚ñ∂ Show';
      }
    }
    
    async function analyzeWithAI(bodyContent) {
      console.log('AI Analysis clicked, body content length:', bodyContent.length);
      
      if (!bodyContent || bodyContent === 'No content') {
        alert('No content available for analysis');
        return;
      }
      
      // Claude 3 Haiku has 200k token limit, so no truncation needed for most content
      console.log('Content length:', bodyContent.length, 'characters');
      
      // Show loading message
      document.getElementById('modalTitle').textContent = 'ü§ñ AI Analysis';
      document.getElementById('modalBody').innerHTML = '<div style="text-align: center; padding: 20px;"><div class="spinner"></div><p>Analyzing content...</p></div>';
      document.getElementById('bodyModal').style.display = 'block';
      
      const prompt = `You are an AI claims assistant helping an insurance adjuster analyze claim communications.

You will receive communication content that may contain email threads, messages, and notes related to ONE SINGLE CLAIM. Even if there are multiple emails in a thread, treat this as ONE CLAIM with multiple communications.

Instructions:

1. Analyze the entire communication thread as ONE CLAIM:
a. Summarize all communications in 2-3 sentences.
b. Extract key facts: claim number, insured name, loss type, all dates mentioned, and any attachments or notes.
c. Determine if the adjuster has responded to all customer questions or requests.
d. Evaluate the adjuster's communication for professionalism, clarity, and completeness.
e. Identify any missing actions or follow-ups.
f. Suggest recommended next steps.
g. Assign a priority: High / Medium / Low.
h. Provide a confidence score (0-100) representing how complete and timely the adjuster's responses are.

2. Return results in JSON format as a SINGLE object (not an array), structured as:
{
  "claim_number": "...",
  "summary": "...",
  "key_facts": {
    "insured_name": "...",
    "loss_type": "...",
    "dates": [...],
    "attachments": [...]
  },
  "adjuster_performance": {
    "professionalism": "...",
    "clarity": "...",
    "completeness": "..."
  },
  "missing_actions": [...],
  "recommended_next_steps": [...],
  "priority": "...",
  "confidence_score": ...
}

Communication content:
${bodyContent}`;
      
      try {
        console.log('Sending to AI service...');
        // Send to AWS AI service via main process
        const result = await ipcRenderer.invoke('analyze-with-ai', prompt);
        console.log('AI service result:', result);
        
        if (result.success) {
          // Display results in modal
          document.getElementById('modalTitle').textContent = 'ü§ñ AI Analysis Results';
          
          // Parse the response if it's a string
          let parsedData = result.data;
          if (typeof parsedData === 'string') {
            try {
              // Try to extract JSON from the string
              const jsonMatch = parsedData.match(/\{[\s\S]*\}/);
              if (jsonMatch) {
                parsedData = JSON.parse(jsonMatch[0]);
              }
            } catch (e) {
              console.log('Failed to parse JSON, using raw string');
            }
          }
          
          // Format the response into readable HTML
          let formattedResponse = parsedData;
          if (typeof formattedResponse === 'object' && formattedResponse !== null) {
            // Format JSON object into readable HTML
            let html = '';
            if (formattedResponse.claim_number) {
              html += `<h3 style="color: #667eea; margin-bottom: 20px;">üìã Claim: ${formattedResponse.claim_number}</h3>`;
            }
            if (formattedResponse.summary) {
              html += `<div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid #28a745;">`;
              html += `<h4 style="color: #28a745; margin: 0 0 10px 0;">üìù Thread Summary</h4>`;
              html += `<p style="margin: 0;">${formattedResponse.summary}</p>`;
              html += `</div>`;
            }
            if (formattedResponse.key_facts) {
              html += `<div style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid #2196f3;">`;
              html += `<h4 style="color: #1976d2; margin: 0 0 10px 0;">üìÑ Key Facts</h4>`;
              if (formattedResponse.key_facts.insured_name) html += `<p style="margin: 5px 0;"><strong>üë§ Insured:</strong> ${formattedResponse.key_facts.insured_name}</p>`;
              if (formattedResponse.key_facts.loss_type) html += `<p style="margin: 5px 0;"><strong>üè• Loss Type:</strong> ${formattedResponse.key_facts.loss_type}</p>`;
              if (formattedResponse.key_facts.dates && formattedResponse.key_facts.dates.length > 0) html += `<p style="margin: 5px 0;"><strong>üìÖ Key Dates:</strong> ${Array.isArray(formattedResponse.key_facts.dates) ? formattedResponse.key_facts.dates.join(', ') : formattedResponse.key_facts.dates}</p>`;
              if (formattedResponse.key_facts.attachments && formattedResponse.key_facts.attachments.length > 0) html += `<p style="margin: 5px 0;"><strong>üìé Attachments:</strong> ${formattedResponse.key_facts.attachments.join(', ')}</p>`;
              html += `</div>`;
            }
            
            if (formattedResponse.adjuster_performance) {
              html += `<div style="background: #f3e5f5; padding: 15px; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid #9c27b0;">`;
              html += `<h4 style="color: #7b1fa2; margin: 0 0 10px 0;">üìä Adjuster Performance</h4>`;
              if (formattedResponse.adjuster_performance.professionalism) html += `<p style="margin: 5px 0;"><strong>Professionalism:</strong> ${formattedResponse.adjuster_performance.professionalism}</p>`;
              if (formattedResponse.adjuster_performance.clarity) html += `<p style="margin: 5px 0;"><strong>Clarity:</strong> ${formattedResponse.adjuster_performance.clarity}</p>`;
              if (formattedResponse.adjuster_performance.completeness) html += `<p style="margin: 5px 0;"><strong>Completeness:</strong> ${formattedResponse.adjuster_performance.completeness}</p>`;
              html += `</div>`;
            }
            
            if (formattedResponse.missing_actions && formattedResponse.missing_actions.length > 0) {
              html += `<div style="background: #fff3e0; padding: 15px; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid #ff9800;">`;
              html += `<h4 style="color: #f57c00; margin: 0 0 10px 0;">‚ö†Ô∏è Missing Actions</h4>`;
              html += `<ul style="margin: 0; padding-left: 20px;">`;
              formattedResponse.missing_actions.forEach(action => {
                html += `<li style="margin: 5px 0;">${action}</li>`;
              });
              html += `</ul></div>`;
            }
            
            if (formattedResponse.recommended_next_steps && formattedResponse.recommended_next_steps.length > 0) {
              html += `<div style="background: #e8f5e8; padding: 15px; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid #4caf50;">`;
              html += `<h4 style="color: #388e3c; margin: 0 0 10px 0;">üìù Recommended Next Steps</h4>`;
              html += `<ul style="margin: 0; padding-left: 20px;">`;
              formattedResponse.recommended_next_steps.forEach(step => {
                html += `<li style="margin: 5px 0;">${step}</li>`;
              });
              html += `</ul></div>`;
            }
            
            html += `<div style="display: flex; gap: 20px; margin-top: 20px;">`;
            if (formattedResponse.priority) {
              const priorityColor = formattedResponse.priority === 'High' ? '#dc3545' : formattedResponse.priority === 'Medium' ? '#ffc107' : '#28a745';
              html += `<div style="background: white; padding: 10px 15px; border-radius: 5px; border: 2px solid ${priorityColor};"><strong>‚ö†Ô∏è Priority:</strong> <span style="color: ${priorityColor}; font-weight: bold;">${formattedResponse.priority}</span></div>`;
            }
            if (formattedResponse.confidence_score) {
              html += `<div style="background: white; padding: 10px 15px; border-radius: 5px; border: 2px solid #28a745;"><strong>üéØ Confidence:</strong> <span style="color: #28a745; font-weight: bold;">${formattedResponse.confidence_score}%</span></div>`;
            }
            html += `</div>`;
            formattedResponse = html;
          } else if (typeof formattedResponse === 'string') {
            // Handle string responses
            formattedResponse = formattedResponse
              .replace(/Claim #: ([^\n]+)/g, '<h3 style="color: #667eea; margin-top: 20px;">üìã Claim #: $1</h3>')
              .replace(/Summary:/g, '<h4 style="color: #28a745; margin-top: 15px;">üìù Summary:</h4>')
              .replace(/\n/g, '<br>');
          } else {
            // Fallback to JSON
            formattedResponse = `<pre style="white-space: pre-wrap; font-family: monospace;">${JSON.stringify(result.data, null, 2)}</pre>`;
          }
          
          document.getElementById('modalBody').innerHTML = `<div style="background: #fafafa; padding: 20px; border-radius: 4px; max-height: 600px; overflow-y: auto;">${formattedResponse}</div>`;
        } else {
          document.getElementById('modalTitle').textContent = '‚ùå AI Analysis Error';
          document.getElementById('modalBody').innerHTML = `<div style="color: red; padding: 15px;">Error: ${result.error}</div>`;
        }
      } catch (error) {
        console.error('AI Analysis error:', error);
        document.getElementById('modalTitle').textContent = '‚ùå AI Analysis Error';
        document.getElementById('modalBody').innerHTML = `<div style="color: red; padding: 15px;">Error: ${error.message}</div>`;
      }
    }
    
    async function sendSMS() {
      const phoneNumber = '+15152019881';
      const message = document.getElementById('smsMessage').value;
      
      if (!message) {
        alert('Please enter a message');
        return;
      }
      
      try {
        const result = await ipcRenderer.invoke('send-sms', phoneNumber, message);
        
        if (result.success) {
          alert(`SMS sent successfully! Message ID: ${result.messageId}`);
          document.getElementById('smsMessage').value = '';
        } else {
          alert(`Failed to send SMS: ${result.error}`);
        }
      } catch (error) {
        alert(`Error sending SMS: ${error.message}`);
      }
    }
    
    async function searchInSource(searchText) {
      if (!searchText || searchText === 'NULL') {
        alert('No search text available');
        return;
      }
      
      document.getElementById('sourceSearchTitle').textContent = `Searching for: "${searchText}"`;
      document.getElementById('sourceSearchBody').innerHTML = '<div style="text-align: center; padding: 20px;"><div class="spinner"></div><p>Searching source files...</p></div>';
      document.getElementById('sourceSearchModal').style.display = 'block';
      
      try {
        const result = await ipcRenderer.invoke('search-source-files', searchText);
        
        if (result.success) {
          if (result.results && result.results.length > 0) {
            let html = `<p><strong>${result.results.length} matches found:</strong></p>`;
            
            result.results.forEach((match, index) => {
              html += `<div style="background: white; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 15px; padding: 15px;">`;
              html += `<h4 style="color: #667eea; margin: 0 0 10px 0;">${match.file.replace(/\\/g, '/')}</h4>`;
              html += `<p style="margin: 5px 0; color: #666;"><strong>Line ${match.line}:</strong></p>`;
              html += `<div style="background: #f8f9fa; border-left: 4px solid #667eea; padding: 10px; font-family: monospace; font-size: 12px;">`;
              
              match.context.forEach(contextLine => {
                const bgColor = contextLine.isMatch ? '#fff3cd' : 'transparent';
                const fontWeight = contextLine.isMatch ? 'bold' : 'normal';
                html += `<div style="background: ${bgColor}; padding: 2px 5px; font-weight: ${fontWeight};"><span style="color: #666; margin-right: 10px;">${contextLine.lineNumber}:</span>${contextLine.content || ''}</div>`;
              });
              
              html += `</div></div>`;
            });
            
            document.getElementById('sourceSearchBody').innerHTML = html;
          } else {
            document.getElementById('sourceSearchBody').innerHTML = '<p>No matches found in source files.</p>';
          }
        } else {
          document.getElementById('sourceSearchBody').innerHTML = `<div class="error">Search failed: ${result.error}</div>`;
        }
      } catch (error) {
        document.getElementById('sourceSearchBody').innerHTML = `<div class="error">Error: ${error.message}</div>`;
      }
    }
    
    function closeSourceSearchModal() {
      document.getElementById('sourceSearchModal').style.display = 'none';
    }
    
    async function openExternalUrl(url) {
      try {
        await ipcRenderer.invoke('open-external-url', url);
      } catch (error) {
        console.error('Failed to open URL:', error);
      }
    }
    
    async function loadLogLevelsChart() {
      const dateFrom = document.getElementById('logsDateFromFilter').value;
      const dateThrough = document.getElementById('logsDateThroughFilter').value;
      const logLevels = getSelectedValues('logLevelFilter');
      
      let whereClause = 'WHERE Logs.IsDeleted = 0';
      if (dateFrom) {
        whereClause += ` AND Logs.CreatedDate >= '${dateFrom}'`;
      }
      if (dateThrough) {
        whereClause += ` AND Logs.CreatedDate <= '${dateThrough} 23:59:59'`;
      }
      if (logLevels.length > 0) {
        const logLevelList = logLevels.map(l => `'${l}'`).join(',');
        whereClause += ` AND Logs.LogLevel IN (${logLevelList})`;
      }
      
      try {
        const result = await ipcRenderer.invoke('execute-query', 
          `SELECT sv.Name as LogLevel, COUNT(*) as Count
           FROM Logs
           INNER JOIN SystemValues sv ON sv.Id = Logs.LogLevel
           ${whereClause}
           GROUP BY sv.Name, sv.Position
           ORDER BY sv.Position`);
        
        if (result.success && result.data) {
          drawLogLevelsPieChart(result.data);
        }
      } catch (error) {
        console.error('Failed to load log levels chart:', error);
      }
    }
    
    function clearLogLevelsChart() {
      const canvas = document.getElementById('logLevelsChart');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
    
    function drawLogLevelsPieChart(data) {
      const canvas = document.getElementById('logLevelsChart');
      const ctx = canvas.getContext('2d');
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      if (!data || data.length === 0) {
        ctx.fillStyle = 'black';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('No data found', canvas.width / 2, canvas.height / 2);
        return;
      }
      
      const total = data.reduce((sum, item) => sum + item.Count, 0);
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const radius = Math.min(centerX, centerY) - 50;
      
      let currentAngle = 0;
      const colors = ['#dc3545', '#ffc107', '#28a745', '#17a2b8', '#6f42c1', '#fd7e14'];
      
      data.forEach((item, index) => {
        const sliceAngle = (item.Count / total) * 2 * Math.PI;
        
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
        ctx.closePath();
        ctx.fillStyle = colors[index % colors.length];
        ctx.fill();
        
        const labelAngle = currentAngle + sliceAngle / 2;
        const labelX = centerX + Math.cos(labelAngle) * (radius * 0.7);
        const labelY = centerY + Math.sin(labelAngle) * (radius * 0.7);
        
        ctx.fillStyle = 'white';
        ctx.font = 'bold 14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(item.LogLevel, labelX, labelY);
        ctx.fillText(item.Count, labelX, labelY + 16);
        
        currentAngle += sliceAngle;
      });
    }
    
    // Close modal when clicking outside of it
    window.onclick = function(event) {
      const bodyModal = document.getElementById('bodyModal');
      const sourceModal = document.getElementById('sourceSearchModal');
      if (event.target === bodyModal) {
        closeBodyModal();
      }
      if (event.target === sourceModal) {
        closeSourceSearchModal();
      }
    }
    
    function drawTimeToReplyChart(data) {
      const canvas = document.getElementById('timeToReplyChart');
      const ctx = canvas.getContext('2d');
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      if (!data || data.length === 0 || data.every(item => (item.AvgTimeToReplyHours || 0) === 0)) {
        ctx.fillStyle = 'black';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('No data found', canvas.width / 2, canvas.height / 2);
        return;
      }
      
      const maxHours = Math.max(...data.map(item => item.AvgTimeToReplyHours || 0));
      const barWidth = (canvas.width - 200) / data.length;
      const maxBarHeight = canvas.height - 180;
      
      const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'];
      
      data.forEach((item, index) => {
        const hours = item.AvgTimeToReplyHours || 0;
        const barHeight = maxHours > 0 ? (hours / maxHours) * maxBarHeight : 0;
        const x = 100 + index * barWidth;
        const y = canvas.height - 160 - barHeight;
        
        ctx.fillStyle = colors[index % colors.length];
        ctx.fillRect(x, y, barWidth - 5, barHeight);
        
        ctx.fillStyle = 'black';
        ctx.font = '10px Arial';
        ctx.textAlign = 'center';
        const displayHours = hours < 1 ? `${Math.round(hours * 60)}m` : `${hours.toFixed(1)}h`;
        ctx.fillText(displayHours, x + barWidth/2, y - 5);
        
        const date = new Date(item.ReplyDate).toLocaleDateString();
        ctx.save();
        ctx.translate(x + barWidth/2, canvas.height - 80);
        ctx.rotate(-Math.PI/4);
        ctx.textAlign = 'right';
        ctx.fillStyle = 'black';
        ctx.font = 'bold 12px Arial';
        ctx.fillText(date, 0, 0);
        ctx.restore();
      });
    }
    

  </script>
</body>
</html>
