<!-- Add this to your existing app.html in the menubar section -->

<!-- In the menubar, add this new menu item after the Database menu: -->
<div class="menu-item" onclick="toggleMenu('aiMenu')">
  ü§ñ AI Assistant
  <div id="aiMenu" class="dropdown">
    <div onclick="showDynamoDBChatPage(); closeAllMenus()">üí¨ DynamoDB Chat</div>
  </div>
</div>

<!-- Add this new page section after your existing pages: -->
<div id="dynamodbChatPage" class="page">
  <div class="query-section">
    <h3>ü§ñ AI Assistant - DynamoDB Chat</h3>
    <p>Ask questions about your DynamoDB data in natural language!</p>
    <div id="dynamodb-chat-status" style="padding: 10px; border-radius: 5px; margin-bottom: 15px;">
      <strong>Status:</strong> <span id="chat-status">Checking connection...</span>
    </div>
  </div>
  
  <div class="results">
    <!-- This is where the chat interface will be rendered -->
    <div id="dynamodb-chat-container" style="height: 600px; border: 1px solid #ddd; border-radius: 5px;"></div>
  </div>
</div>

<!-- Add these JavaScript functions to your existing script section: -->
<script>
// DynamoDB Chat Integration
let dynamoDBAgent = null;

function showDynamoDBChatPage() {
  showPage('dynamodbChatPage');
  
  // Initialize the chat interface if not already done
  if (!dynamoDBAgent) {
    initializeDynamoDBChat();
  }
}

async function initializeDynamoDBChat() {
  try {
    // Check if the DynamoDB server is running
    const statusEl = document.getElementById('chat-status');
    statusEl.textContent = 'Connecting to DynamoDB agent...';
    
    const response = await fetch('http://localhost:5000/api/health');
    const health = await response.json();
    
    if (health.agent_ready) {
      statusEl.textContent = '‚úÖ Connected and ready';
      statusEl.parentElement.style.background = '#d4edda';
      statusEl.parentElement.style.color = '#155724';
      
      // Load the chat interface
      loadDynamoDBChatInterface();
    } else {
      statusEl.textContent = '‚ö†Ô∏è Agent not ready - check AWS credentials';
      statusEl.parentElement.style.background = '#fff3cd';
      statusEl.parentElement.style.color = '#856404';
      
      showSetupInstructions();
    }
  } catch (error) {
    const statusEl = document.getElementById('chat-status');
    statusEl.textContent = '‚ùå Server not running';
    statusEl.parentElement.style.background = '#f8d7da';
    statusEl.parentElement.style.color = '#721c24';
    
    showServerInstructions();
  }
}

function loadDynamoDBChatInterface() {
  const container = document.getElementById('dynamodb-chat-container');
  
  container.innerHTML = `
    <div style="display: flex; flex-direction: column; height: 100%; font-family: inherit;">
      <div style="padding: 15px; background: #f8f9fa; border-bottom: 1px solid #dee2e6;">
        <h4 style="margin: 0 0 10px 0;">üí¨ Ask about your DynamoDB data</h4>
        <div id="suggestions" style="display: flex; flex-wrap: wrap; gap: 6px;"></div>
      </div>
      
      <div id="chat-messages" style="flex: 1; overflow-y: auto; padding: 15px; background: white;"></div>
      
      <div style="padding: 15px; background: #f8f9fa; border-top: 1px solid #dee2e6; display: flex; gap: 10px;">
        <input type="text" id="chat-input" placeholder="Ask about your DynamoDB data..." 
               style="flex: 1; padding: 10px; border: 1px solid #ced4da; border-radius: 20px; outline: none;">
        <button id="send-button" onclick="sendDynamoDBQuery()" 
                style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 20px; cursor: pointer;">
          Send
        </button>
      </div>
    </div>
  `;
  
  // Load suggestions
  loadChatSuggestions();
  
  // Add welcome message
  addChatMessage('üëã Hi! I can help you query your DynamoDB data. Try asking me something like "What tables do I have?" or click one of the suggestions above.', false);
  
  // Set up enter key handler
  document.getElementById('chat-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      sendDynamoDBQuery();
    }
  });
}

async function loadChatSuggestions() {
  try {
    const response = await fetch('http://localhost:5000/api/suggestions');
    const data = await response.json();
    
    const suggestionsEl = document.getElementById('suggestions');
    data.suggestions.slice(0, 6).forEach(suggestion => {
      const span = document.createElement('span');
      span.style.cssText = 'font-size: 11px; padding: 4px 8px; background: #e9ecef; border-radius: 12px; cursor: pointer; transition: background-color 0.2s;';
      span.textContent = suggestion;
      span.onclick = () => {
        document.getElementById('chat-input').value = suggestion;
        sendDynamoDBQuery();
      };
      span.onmouseover = () => span.style.background = '#dee2e6';
      span.onmouseout = () => span.style.background = '#e9ecef';
      suggestionsEl.appendChild(span);
    });
  } catch (error) {
    console.error('Failed to load suggestions:', error);
  }
}

function addChatMessage(content, isUser = false) {
  const messagesEl = document.getElementById('chat-messages');
  const messageDiv = document.createElement('div');
  messageDiv.style.cssText = `margin-bottom: 15px; max-width: 80%; ${isUser ? 'margin-left: auto; text-align: right;' : ''}`;
  
  const contentDiv = document.createElement('div');
  contentDiv.style.cssText = `
    padding: 10px 15px; 
    border-radius: 18px; 
    font-size: 14px; 
    line-height: 1.4;
    ${isUser ? 
      'background: #667eea; color: white;' : 
      'background: #f8f9fa; color: #495057; white-space: pre-wrap; font-family: Monaco, Menlo, monospace; font-size: 12px;'
    }
  `;
  contentDiv.textContent = content;
  
  messageDiv.appendChild(contentDiv);
  messagesEl.appendChild(messageDiv);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

async function sendDynamoDBQuery() {
  const input = document.getElementById('chat-input');
  const query = input.value.trim();
  
  if (!query) return;
  
  addChatMessage(query, true);
  input.value = '';
  
  const sendButton = document.getElementById('send-button');
  sendButton.disabled = true;
  sendButton.textContent = 'Thinking...';
  
  // Show thinking message
  addChatMessage('ü§î Analyzing your request...');
  
  try {
    const response = await fetch('http://localhost:5000/api/query', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ query: query })
    });
    
    const data = await response.json();
    
    // Remove thinking message
    const messagesEl = document.getElementById('chat-messages');
    messagesEl.removeChild(messagesEl.lastChild);
    
    if (data.success) {
      addChatMessage(data.response);
    } else {
      addChatMessage(`‚ùå Error: ${data.error}`);
    }
  } catch (error) {
    // Remove thinking message
    const messagesEl = document.getElementById('chat-messages');
    messagesEl.removeChild(messagesEl.lastChild);
    
    addChatMessage(`‚ùå Network error: ${error.message}`);
  } finally {
    sendButton.disabled = false;
    sendButton.textContent = 'Send';
    input.focus();
  }
}

function showSetupInstructions() {
  const container = document.getElementById('dynamodb-chat-container');
  container.innerHTML = `
    <div style="padding: 30px; text-align: center;">
      <h3>üîß Setup Required</h3>
      <p>The DynamoDB agent server is running, but AWS credentials need to be configured.</p>
      
      <div style="background: #f8f9fa; padding: 20px; border-radius: 5px; margin: 20px 0; text-align: left;">
        <h4>Setup Steps:</h4>
        <ol>
          <li><strong>Configure AWS Credentials:</strong>
            <ul>
              <li>Run: <code>aws configure</code></li>
              <li>Or set environment variables: <code>AWS_ACCESS_KEY_ID</code> and <code>AWS_SECRET_ACCESS_KEY</code></li>
              <li>Or set Bedrock API key: <code>AWS_BEDROCK_API_KEY</code></li>
            </ul>
          </li>
          <li><strong>Ensure DynamoDB Permissions:</strong>
            <ul>
              <li>Your AWS user/role needs DynamoDB read permissions</li>
              <li>At minimum: <code>dynamodb:ListTables</code>, <code>dynamodb:DescribeTable</code>, <code>dynamodb:Scan</code>, <code>dynamodb:Query</code></li>
            </ul>
          </li>
          <li><strong>Refresh this page</strong> after configuring credentials</li>
        </ol>
      </div>
      
      <button onclick="initializeDynamoDBChat()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
        Retry Connection
      </button>
    </div>
  `;
}

function showServerInstructions() {
  const container = document.getElementById('dynamodb-chat-container');
  container.innerHTML = `
    <div style="padding: 30px; text-align: center;">
      <h3>üöÄ Start DynamoDB Server</h3>
      <p>The DynamoDB agent server needs to be started first.</p>
      
      <div style="background: #f8f9fa; padding: 20px; border-radius: 5px; margin: 20px 0; text-align: left;">
        <h4>Start the server:</h4>
        <ol>
          <li>Open a command prompt/terminal</li>
          <li>Navigate to your project directory</li>
          <li>Run: <code>python dynamodb_web_server.py</code></li>
          <li>Wait for "DynamoDB Web Server..." message</li>
          <li>Refresh this page</li>
        </ol>
        
        <div style="background: #e3f2fd; padding: 10px; border-radius: 3px; margin-top: 15px;">
          <strong>üí° Tip:</strong> The server will run at <code>http://localhost:5000</code>
        </div>
      </div>
      
      <button onclick="initializeDynamoDBChat()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
        Check Connection
      </button>
    </div>
  `;
}

// Add this to your existing showPage function or create it if it doesn't exist
function showPage(pageId) {
  // Hide all pages
  document.querySelectorAll('.page').forEach(page => {
    page.classList.remove('active');
  });
  
  // Show selected page
  document.getElementById(pageId).classList.add('active');
}
</script>